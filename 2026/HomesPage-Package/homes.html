<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Find Your Home - Bonita Springs & Estero</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <style>
    :root {
      --primary: #1a2a3a;
      --accent: #2596be;
      --accent-light: #e8f7fc;
      --bg: #f5f6f8;
      --text: #333;
      --white: #fff;
      --header-bg: rgba(20, 20, 20, 0.92);
      --hot: #ef4444;
      --cold: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --pending: #8b5cf6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* --- Header --- */
    #top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: var(--header-bg);
      padding: 8px 24px;
      z-index: 10000;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    #bar-width {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 1400px;
      justify-content: space-between;
    }

    .brand-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
    }

    .ber-logo {
      height: 36px;
      width: auto;
      object-fit: contain;
    }

    .bser-title {
      color: var(--white);
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .navbar-expand-md {
      display: flex;
      gap: 18px;
      list-style: none;
    }

    .navbar-expand-md a {
      color: var(--white);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.85;
      transition: opacity 0.2s;
    }

    .navbar-expand-md a:hover {
      opacity: 1;
    }

    /* --- Compact Filter Bar (single row) --- */
    .filters-container {
      margin-top: 52px;
      background: var(--white);
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 0;
      position: sticky;
      top: 52px;
      z-index: 500;
    }

    .filters-outer {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 16px;
      gap: 16px;
    }

    .filters-row-top,
    .filters-row-bottom {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .filters-row-top {
      justify-content: flex-start;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 8px;
    }

    .filters-row-bottom {
      justify-content: flex-start;
    }

    .filter-arrow {
      background: transparent;
      border: 1px solid #ddd;
      cursor: pointer;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      color: #333;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .filter-arrow:hover {
      background: #ddd;
    }

    .filters-bar {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 0 4px;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .filters-bar::-webkit-scrollbar {
      display: none;
    }

    /* Search Bar */
    .search-input-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .search-input-wrap input {
      padding: 8px 12px 8px 36px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      width: 240px;
      background: #fff;
    }

    .search-input-wrap i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #666;
    }

    /* Generic Dropdown */
    .filter-dropdown-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .filter-dropdown-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .filter-dropdown-btn:after {
      content: '\f0d7';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      font-size: 10px;
      color: #999;
      margin-left: 2px;
    }

    .filter-dropdown-btn.has-value {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }

    .filter-dropdown-panel {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      z-index: 600;
      min-width: 200px;
    }

    .filter-dropdown-panel.open {
      display: block;
    }

    /* Panel Specifics */
    .filter-dropdown-panel label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-dropdown-panel input[type="checkbox"],
    .filter-dropdown-panel input[type="radio"] {
      accent-color: var(--accent);
      width: 14px;
      height: 14px;
      cursor: pointer;
    }

    .filter-dropdown-panel input[type="number"] {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: inherit;
      margin-bottom: 10px;
      background: #f9f9f9;
    }

    .filter-dropdown-panel .apply-btn {
      width: 100%;
      padding: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .filter-dropdown-panel .apply-btn:hover {
      background: #1e7fa3;
    }

    /* Button Group (Beds/Baths) */
    .filter-btn-group {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }

    .filter-option-btn {
      flex: 1;
      padding: 6px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 5px;
      font-size: 0.75rem;
      cursor: pointer;
      text-align: center;
      color: #555;
      transition: all 0.2s;
    }

    .filter-option-btn:hover {
      background: #f5f5f5;
    }

    .filter-option-btn.selected {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .pill-group {
      display: flex;
      background: #f7f7f7;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 2px;
      gap: 2px;
      flex-shrink: 0;
    }

    .pill-btn {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      color: #555;
      transition: all 0.2s;
      white-space: nowrap;
      font-family: inherit;
    }

    .pill-btn.active {
      background: #1a2a3a;
      color: #fff;
    }

    .pill-btn:hover:not(.active) {
      background: #eee;
    }

    /* Redesigned Status Pills */
    #statusPills {
      background: transparent;
      border: none;
      gap: 8px;
    }

    .status-pill {
      border: 1px solid #e0e0e0;
      background: #fff;
      padding: 6px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
      transition: all 0.2s;
    }

    .status-pill.active[data-status="Active"] {
      background: #22c55e;
      border-color: #22c55e;
      color: #fff;
    }

    .status-pill.active[data-status="Pending"] {
      background: #ffecf0;
      border-color: #e91e63;
      color: #e91e63;
    }

    .status-pill.active[data-status="Closed"] {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #374151;
    }

    .filter-select {
      padding: 5px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.78rem;
      font-family: inherit;
      background: #fff;
      min-width: 80px;
      flex-shrink: 0;
    }

    .filter-input {
      padding: 5px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.78rem;
      font-family: inherit;
      width: 85px;
      flex-shrink: 0;
    }

    .search-btn {
      padding: 5px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.75rem;
      font-family: inherit;
      flex-shrink: 0;
    }

    .search-btn:hover {
      background: #1e7fa3;
    }

    .search-btn.secondary {
      background: #adb5bd;
      border-radius: 20px;
      padding: 6px 16px;
      color: #fff;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .filter-divider {
      width: 1px;
      height: 24px;
      background: #ddd;
      flex-shrink: 0;
    }

    .results-count {
      font-size: 0.75rem;
      color: #888;
      margin-left: auto;
      white-space: nowrap;
      font-weight: 500;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .loading-indicator {
      display: none;
      color: var(--accent);
      font-size: 0.8rem;
    }

    /* --- BSER Banner --- */
    .desc-banner {
      padding: 6px 16px;
      background: linear-gradient(135deg, var(--primary), #2c3e50);
      color: var(--white);
      text-align: center;
      font-size: 0.75rem;
    }

    .desc-banner strong {
      font-weight: 600;
    }

    /* --- Carousel --- */
    .carousels-wrapper {
      width: 100%;
      background: #fff;
      border-bottom: 1px solid #eee;
      display: none;
    }

    .carousel-container {
      padding: 10px 0;
      position: relative;
      z-index: 10;
    }

    .carousel-header {
      padding: 0 16px 6px;
      display: flex;
      align-items: center;
    }

    .carousel-header h2 {
      font-size: 0.9rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #333;
      font-weight: 600;
    }

    .badge-new {
      background: var(--accent);
      color: #fff;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .carousel-track {
      display: flex;
      gap: 10px;
      padding: 0 16px;
      overflow: hidden;
    }

    .carousel-card {
      flex: 0 0 200px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .carousel-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .carousel-img-wrapper {
      position: relative;
      height: 110px;
      background: #eee;
      overflow: hidden;
    }

    .carousel-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* --- Main Layout --- */
    .main-container {
      display: flex;
      height: calc(100vh - 120px);
      min-height: 400px;
    }

    .map-section {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .leaflet-pane img:not(.popup-img) {
      max-width: none !important;
      width: auto !important;
      height: auto !important;
      box-shadow: none !important;
      border: none !important;
    }

    /* --- Listings Panel --- */
    .listings-section {
      width: 380px;
      background: var(--bg);
      overflow-y: auto;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.04);
      z-index: 5;
    }

    .listings-grid {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* --- Listing Cards --- */
    .listing-card {
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      transition: all 0.2s;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
    }

    .listing-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
    }

    .listing-card.active {
      border-color: var(--accent);
    }

    .card-img-wrapper {
      position: relative;
      height: 160px;
      background: #eee;
      overflow: hidden;
    }

    .card-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .listing-card:hover .card-img {
      transform: scale(1.03);
    }

    .price-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: 700;
      font-size: 0.9rem;
      backdrop-filter: blur(4px);
    }

    .status-badge-card {
      position: absolute;
      top: 6px;
      left: 6px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .status-badge-card.active {
      background: var(--success);
      color: #fff;
    }

    .status-badge-card.pending {
      background: var(--pending);
      color: #fff;
    }

    .status-badge-card.auc {
      background: var(--warning);
      color: #fff;
    }

    .card-content {
      padding: 8px 10px;
    }

    .card-address {
      font-weight: 600;
      margin-bottom: 3px;
      color: var(--primary);
      font-size: 0.82rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-details {
      display: flex;
      gap: 10px;
      font-size: 0.78rem;
      color: #666;
      margin-bottom: 4px;
    }

    .card-detail-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.72rem;
      color: #999;
    }

    .card-subtype {
      font-size: 0.65rem;
      color: #888;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Save Button on Card */
    .card-save-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.4);
      border: none;
      color: #fff;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
      backdrop-filter: blur(2px);
    }

    .card-save-btn:hover {
      background: rgba(0, 0, 0, 0.6);
    }

    .card-save-btn.saved {
      background: var(--hot);
      color: #fff;
    }

    /* Card Arrows */
    .card-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.4);
      color: white;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
      z-index: 10;
      border-radius: 3px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card-img-wrapper:hover .card-arrow {
      opacity: 1;
    }

    .card-arrow.left {
      left: 4px;
    }

    .card-arrow.right {
      right: 4px;
    }

    .photo-count {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 0.62rem;
      padding: 1px 5px;
      border-radius: 8px;
      z-index: 5;
    }

    /* --- Map Popups --- */
    .leaflet-popup-content-wrapper {
      border-radius: 12px !important;
      padding: 0 !important;
      overflow: hidden !important;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
    }

    .leaflet-popup-content {
      margin: 0 !important;
      width: 260px !important;
    }

    .popup-content {
      padding: 0;
      width: 260px;
      background: #fff;
    }

    .popup-img {
      width: 100% !important;
      height: 120px !important;
      object-fit: cover !important;
      display: block !important;
      border-bottom: 1px solid #eee;
    }

    .popup-info {
      padding: 12px;
    }

    .popup-price {
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .popup-address {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .popup-details {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      color: #777;
      margin-bottom: 12px;
    }

    .popup-btn {
      width: 100%;
      padding: 8px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s;
    }

    .popup-btn:hover {
      background: #1e7fa3;
    }

    .price-pin {
      background: #fff;
      color: #333;
      padding: 2px 6px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      text-align: center;
      border: 2px solid #ccc;
      white-space: nowrap;
      display: inline-block;
      transition: all 0.2s;
      cursor: pointer;
    }

    .price-pin:hover {
      transform: scale(1.15);
      z-index: 1000 !important;
    }


    /* --- Detail Modal --- */
    .detail-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 20000;
      backdrop-filter: blur(3px);
      overflow-y: auto;
    }

    .detail-modal {
      margin: 40px auto;
      background: #fff;
      border-radius: 14px;
      width: 92%;
      max-width: 900px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      position: relative;
    }

    .detail-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #fff;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }

    .detail-close:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .detail-gallery {
      position: relative;
      min-height: 200px;
      /* Allow height to grow if needed up to a limit, but don't force it */
      height: auto;
      max-height: 40vh;
      background: #f4f4f4;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-gallery-img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .detail-gallery-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      font-size: 20px;
      border-radius: 6px;
    }

    .detail-gallery-nav.prev {
      left: 10px;
    }

    .detail-gallery-nav.next {
      right: 10px;
    }

    .detail-gallery-nav:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .detail-gallery-count {
      position: absolute;
      bottom: 10px;
      right: 14px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .detail-gallery-thumbs {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: #f8f8f8;
      overflow-x: auto;
    }

    .detail-thumb {
      width: 60px;
      height: 44px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.2s;
      flex-shrink: 0;
    }

    .detail-thumb.active {
      border-color: var(--accent);
    }

    .detail-body {
      padding: 20px 24px;
      position: relative;
      background: #fff;
      z-index: 5;
    }

    .detail-price {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .detail-addr {
      font-size: 1rem;
      color: #555;
      margin-bottom: 12px;
    }

    .detail-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .detail-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: #555;
    }

    .detail-stat i {
      color: var(--accent);
    }

    .detail-badges {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .detail-badge {
      padding: 3px 10px;
      border-radius: 14px;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .detail-description {
      font-size: 0.88rem;
      line-height: 1.6;
      color: #555;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .detail-agent-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .detail-agent-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--primary);
    }

    .detail-agent-office {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 10px;
    }

    .detail-agent-btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .detail-agent-btn {
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      border: none;
      transition: all 0.2s;
    }

    .detail-agent-btn.primary {
      background: var(--accent);
      color: #fff;
    }

    .detail-agent-btn.primary:hover {
      background: #1e7fa3;
    }

    .detail-agent-btn.outline {
      background: transparent;
      border: 1.5px solid var(--accent);
      color: var(--accent);
    }

    .detail-agent-btn.outline:hover {
      background: var(--accent-light);
    }

    .detail-save-btn {
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      border: 1.5px solid #ddd;
      background: #fff;
      color: #555;
      transition: all 0.2s;
    }

    .detail-save-btn:hover {
      border-color: var(--hot);
      color: var(--hot);
    }

    .detail-save-btn.saved {
      background: var(--hot);
      color: #fff;
      border-color: var(--hot);
    }

    .detail-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* --- Contact Modal --- */
    .contact-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 25000;
    }

    .contact-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 14px;
      width: 90%;
      max-width: 480px;
      padding: 28px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .contact-modal h3 {
      font-size: 1.1rem;
      margin-bottom: 4px;
      color: var(--primary);
    }

    .contact-modal .sub {
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 16px;
    }

    .contact-form label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: #555;
      margin-bottom: 4px;
      margin-top: 10px;
    }

    .contact-form input,
    .contact-form textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
    }

    .contact-form textarea {
      height: 100px;
      resize: vertical;
    }

    .contact-form .send-btn {
      margin-top: 14px;
      width: 100%;
      padding: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .contact-form .send-btn:hover {
      background: #1e7fa3;
    }

    .contact-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f0f0f0;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
    }

    /* --- Agent Modal --- */
    .agent-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 20000;
      backdrop-filter: blur(3px);
    }

    .agent-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 14px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .agent-modal-header {
      padding: 20px;
      background: linear-gradient(135deg, var(--primary), #2c3e50);
      color: #fff;
      border-radius: 14px 14px 0 0;
      position: relative;
    }

    .agent-modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .agent-name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .agent-office {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .agent-listings-grid {
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }

    .agent-listing-card {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .agent-listing-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .agent-card-img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      background: #eee;
    }

    .agent-card-info {
      padding: 6px 8px;
    }

    .agent-card-price {
      font-weight: 700;
      font-size: 0.88rem;
      color: var(--primary);
    }

    .agent-card-addr {
      font-size: 0.72rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Saved Cart FAB --- */
    .cart-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 15000;
      background: var(--primary);
      color: #fff;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
    }

    .cart-fab:hover {
      transform: scale(1.1);
    }

    .cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--hot);
      color: #fff;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 0.65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cart-panel {
      display: none;
      position: fixed;
      bottom: 84px;
      right: 24px;
      z-index: 15000;
      background: #fff;
      border-radius: 14px;
      width: 340px;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }

    .cart-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-header h3 {
      font-size: 0.95rem;
      margin: 0;
    }

    .cart-clear {
      background: none;
      border: none;
      color: var(--hot);
      font-size: 0.75rem;
      cursor: pointer;
      font-weight: 600;
    }

    .cart-items {
      padding: 8px;
    }

    .cart-item {
      display: flex;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      align-items: center;
    }

    .cart-item:hover {
      background: #f5f5f5;
    }

    .cart-item-img {
      width: 60px;
      height: 44px;
      object-fit: cover;
      border-radius: 5px;
      flex-shrink: 0;
      background: #eee;
    }

    .cart-item-info {
      flex: 1;
      min-width: 0;
    }

    .cart-item-price {
      font-weight: 700;
      font-size: 0.82rem;
      color: var(--primary);
    }

    .cart-item-addr {
      font-size: 0.7rem;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cart-item-remove {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 14px;
      flex-shrink: 0;
    }

    .cart-item-remove:hover {
      color: var(--hot);
    }

    .cart-empty {
      padding: 30px;
      text-align: center;
      color: #bbb;
      font-size: 0.85rem;
    }

    /* --- Loading --- */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 18000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }

    /* --- Elementor Override --- */
    .elementor img {
      border: none;
      border-radius: 0;
      box-shadow: none;
    }

    html body .ber-logo,
    html body img.ber-logo,
    html body .brand-wrapper img,
    html body .elementor img.ber-logo,
    html body .elementor .brand-wrapper img {
      width: auto !important;
      height: 36px !important;
      max-width: 180px !important;
      min-width: unset !important;
      object-fit: contain !important;
      border: none !important;
      box-shadow: none !important;
      margin: 0 !important;
      display: block !important;
    }

    @media (max-width: 900px) {
      .navbar-expand-md {
        display: none !important;
      }

      #top-bar {
        display: none !important;
      }

      .filters-container {
        margin-top: 0;
        top: 60px;
        padding: 10px 0;
        box-shadow: none;
        border-top: 1px solid #f0f0f0;
      }

      .main-container {
        flex-direction: column;
        height: calc(100vh - 120px);
      }

      .listings-section {
        display: none;
        /* Hide desktop listings on mobile */
      }

      .map-section {
        height: 100%;
        width: 100%;
      }

      .ber-logo {
        height: 24px !important;
      }

      .bser-title {
        font-size: 0.8rem !important;
      }
    }

    /* --- Mobile Specific Header --- */
    .mobile-header {
      display: none;
      background: #fff;
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 2000;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 900px) {
      .mobile-header {
        display: flex;
        align-items: center;
        gap: 12px;
      }
    }

    .mobile-search-bar {
      flex: 1;
      background: #f5f5f5;
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mobile-search-bar input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 0.95rem;
      width: 100%;
      color: #333;
    }

    .mobile-search-bar i {
      color: #666;
    }

    .mobile-save-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #333;
      text-decoration: none;
    }

    .mobile-save-btn i {
      font-size: 1.2rem;
      margin-bottom: 2px;
    }

    /* --- Bottom Sheet --- */
    .bottom-sheet {
      display: none;
      position: fixed;
      bottom: 60px;
      /* Above bottom nav */
      left: 0;
      right: 0;
      background: #fff;
      z-index: 1500;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease-out;
      max-height: 85vh;
      overflow: hidden;
    }

    @media (max-width: 900px) {
      .bottom-sheet {
        display: flex;
        flex-direction: column;
      }
    }

    .bottom-sheet.collapsed {
      transform: translateY(calc(100% - 100px));
    }

    .bottom-sheet-handle {
      width: 40px;
      height: 4px;
      background: #eee;
      border-radius: 2px;
      margin: 8px auto;
      cursor: grab;
    }

    .bottom-sheet-header {
      padding: 0 16px 12px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }

    .bottom-sheet-header h3 {
      font-size: 1rem;
      margin-bottom: 4px;
      font-weight: 700;
    }

    .bottom-sheet-header span {
      font-size: 0.85rem;
      color: #777;
    }

    .bottom-sheet-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* --- Bottom Nav --- */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #eee;
      padding: 8px 0;
      z-index: 2000;
      justify-content: space-around;
      align-items: center;
    }

    @media (max-width: 900px) {
      .bottom-nav {
        display: flex;
      }
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: #777;
      font-size: 0.7rem;
      font-weight: 600;
      flex: 1;
    }

    .nav-item i {
      font-size: 1.25rem;
    }

    .nav-item.active {
      color: #e63946;
    }

    /* --- Clustering Styles --- */
    .marker-cluster-small {
      background-color: rgba(26, 42, 58, 0.6);
    }

    .marker-cluster-small div {
      background-color: rgba(26, 42, 58, 0.85);
      color: #fff;
    }

    .marker-cluster-medium {
      background-color: rgba(26, 42, 58, 0.6);
    }

    .marker-cluster-medium div {
      background-color: rgba(26, 42, 58, 0.85);
      color: #fff;
    }

    .marker-cluster-large {
      background-color: rgba(26, 42, 58, 0.6);
    }

    .marker-cluster-large div {
      background-color: rgba(26, 42, 58, 0.85);
      color: #fff;
    }

    .marker-cluster div {
      width: 34px;
      height: 34px;
      margin-left: 3px;
      margin-top: 3px;
      text-align: center;
      border-radius: 17px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Footer Disclaimer */
    .footer-disclaimer {
      background: #f9f9f9;
      padding: 40px 20px;
      font-size: 0.7rem;
      color: #666;
      border-top: 1px solid #e0e0e0;
      text-align: center;
      line-height: 1.6;
    }

    .footer-disclaimer p {
      margin-bottom: 12px;
    }

    .footer-disclaimer strong {
      color: #333;
    }

    /* Map Loader */
    .map-section {
      position: relative;
    }

    .map-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
      transition: opacity 0.3s;
    }

    .map-loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top:15px;color:#fff;font-weight:600" id="loadingText">Loading properties...</div>
  </div>

  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="mobileSearchInput" placeholder="City, neighborhood, address, zip...">
    </div>
    <a href="#" class="mobile-save-btn" id="mobileSaveBtn">
      <i class="far fa-heart"></i>
      <span>Save</span>
    </a>
  </div>

  <!-- Header -->
  <div id="top-bar">
    <div id="bar-width">
      <a href="/" class="brand-wrapper">
        <img class="ber-logo"
          src="https://www.bonitaesterorealtors.com/wp-content/uploads/2021/08/Untitled-design-24.png" alt="BSER">
        <div class="bser-title">BSER Lifestyles</div>
      </a>
      <ul class="navbar-expand-md">
        <li><a href="https://bonitaspringsesterolifestyles.com/communities/">Communities</a></li>
        <li><a href="http://bonitaspringsesterorealtorsfl.growthzoneapp.com/realtordirectory/Find">Find a REALTOR</a>
        </li>
        <li><a href="/homes.html">Homes For Sale</a></li>
        <li><a href="https://bonitaspringsesterolifestyles.com/city-info/">City Info</a></li>
      </ul>
    </div>
  </div>

  <div class="desc-banner">Listings exclusively from <strong>Bonita Springs-Estero REALTORS&reg;</strong> member agents
  </div>

  <!-- Compact Filter Bar -->
  <div class="filters-container">
    <div class="filters-outer">
      <!-- Top Row: Filters -->
      <div class="filters-row-top">
        <div class="pill-group" id="propertyTypePills">
          <button class="pill-btn active" data-type="sale">For Sale</button>
          <button class="pill-btn" data-type="rental">Rental</button>
          <button class="pill-btn" data-type="commercial">Commercial</button>
          <button class="pill-btn" data-type="land">Lot &amp; Land</button>
        </div>
        <div class="filter-divider"></div>
        <button class="filter-arrow" id="filterLeft"><i class="fas fa-chevron-left"></i></button>
        <div class="filters-bar" id="filtersBar">
          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="priceBtn">Price</button>
            <div class="filter-dropdown-panel" id="pricePanel">
              <label>Price Range</label>
              <div class="filter-btn-group">
                <input type="number" id="priceMin" placeholder="No Min">
                <input type="number" id="priceMax" placeholder="No Max">
              </div>
              <button class="apply-btn" id="priceApplyBtn">Apply</button>
            </div>
          </div>

          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="subTypeBtn">Home Type</button>
            <div class="filter-dropdown-panel" id="subTypePanel" style="width:220px">
              <label><input type="checkbox" value="Single Family Residence" checked> Single Family</label>
              <label><input type="checkbox" value="Condominium" checked> Condo</label>
              <label><input type="checkbox" value="Townhouse" checked> Townhouse</label>
              <label><input type="checkbox" value="Multi Family" checked> Multi Family</label>
              <label><input type="checkbox" value="Villa" checked> Villa</label>
              <button class="apply-btn">Apply</button>
            </div>
          </div>

          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="bedsBtn">Beds</button>
            <div class="filter-dropdown-panel" id="bedsPanel" style="width:280px">
              <label>Bedrooms</label>
              <div class="filter-btn-group" id="bedsGroup">
                <button class="filter-option-btn selected" data-val="0">Any</button>
                <button class="filter-option-btn" data-val="1">1+</button>
                <button class="filter-option-btn" data-val="2">2+</button>
                <button class="filter-option-btn" data-val="3">3+</button>
                <button class="filter-option-btn" data-val="4">4+</button>
                <button class="filter-option-btn" data-val="5">5+</button>
              </div>
              <button class="apply-btn" id="bedsApplyBtn">Apply</button>
            </div>
          </div>

          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="bathsBtn">Baths</button>
            <div class="filter-dropdown-panel" id="bathsPanel" style="width:240px">
              <label>Bathrooms</label>
              <div class="filter-btn-group" id="bathsGroup">
                <button class="filter-option-btn selected" data-val="0">Any</button>
                <button class="filter-option-btn" data-val="1">1+</button>
                <button class="filter-option-btn" data-val="2">2+</button>
                <button class="filter-option-btn" data-val="3">3+</button>
                <button class="filter-option-btn" data-val="4">4+</button>
              </div>
              <button class="apply-btn" id="bathsApplyBtn">Apply</button>
            </div>
          </div>

          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="cityBtn">City</button>
            <div class="filter-dropdown-panel" id="cityPanel">
              <label><input type="checkbox" name="city" value="Bonita Springs" checked> Bonita Springs</label>
              <label><input type="checkbox" name="city" value="Estero" checked> Estero</label>
              <label><input type="checkbox" name="city" value="Naples"> Naples</label>
              <label><input type="checkbox" name="city" value="Fort Myers"> Fort Myers</label>
              <button class="apply-btn">Apply</button>
            </div>
          </div>

          <div class="filter-dropdown-wrap">
            <button class="filter-dropdown-btn" id="sortBtn">Sort</button>
            <div class="filter-dropdown-panel" id="sortPanel">
              <label><input type="radio" name="sort" value="dateDesc" checked> Newest Listing</label>
              <label><input type="radio" name="sort" value="priceDesc"> Price (High to Low)</label>
              <label><input type="radio" name="sort" value="priceAsc"> Price (Low to High)</label>
              <button class="apply-btn">Apply</button>
            </div>
          </div>
        </div>
        <button class="filter-arrow" id="filterRight"><i class="fas fa-chevron-right"></i></button>
        <button class="search-btn secondary" id="clearFiltersBtn">Clear</button>
      </div>

      <!-- Bottom Row: Search & Info -->
      <div class="filters-row-bottom">
        <div class="search-input-wrap">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Address, ZIP, MLS...">
        </div>
        <div id="capBanner"
          style="display:none;background:linear-gradient(135deg,#1e3a5f,#2563eb);color:#fff;padding:8px 16px;border-radius:10px;font-size:0.85rem;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.15);flex:1">
          <i class="fas fa-info-circle" style="margin-right:6px"></i>
          <span id="capBannerText"></span>
        </div>
        <div class="results-count">
          <span class="loading-indicator" id="listLoader"><i class="fas fa-spinner fa-spin"></i></span>
          <span id="resultsCount">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Carousel -->
  <div class="carousels-wrapper" id="carouselsWrapper">
    <div class="carousel-container" id="featuredCarousel">
      <div class="carousel-header">
        <h2>Just Listed <span class="badge-new" id="newCount">New</span></h2>
      </div>
      <div class="carousel-track" id="carouselTrack"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="main-container" id="mainContainer">
    <div class="map-section">
      <div id="map"></div>
      <div class="map-loading-overlay center-ref" id="mapLoader">
        <div class="spinner"></div>
        <div style="margin-top:10px;font-weight:600;color:#555">Loading Map Properties...</div>
      </div>
    </div>
    <div class="listings-section">
      <div class="listings-grid" id="listingsGrid"></div>
    </div>
  </div>

  <footer class="footer-disclaimer">
    <p><strong>Real estate agents ready to serve you | Browse homes and real estate for sale</strong></p>
    <p>This website is made by <strong>Bonita Springs-Estero REALTORS&reg;</strong>.</p>
    <p>Disclaimer: All information deemed reliable but not guaranteed. All properties are subject to prior sale,
      change
      or withdrawal. Neither listing broker(s) or information provider(s) shall be responsible for any typographical
      errors, misinformation, misprints and shall be held totally harmless. Listing(s) information is provided for
      consumers personal, non-commercial use and may not be used for any purpose other than to identify prospective
      properties consumers may be interested in purchasing.</p>
    <p>Information on this site was last updated <span id="lastUpdatedDate">Loading...</span>. The listing information
      on this page last changed on <span id="lastChangedDate">Loading...</span>.</p>
    <p>The data relating to real estate for sale on this website comes in part from the Internet Data Exchange program
      of (last updated <span id="deltaUpdated">Loading...</span>) or Bonita Springs MLS (last
      updated <span id="bsUpdated">Loading...</span>).</p>
    <p>Real estate listings held by brokerage firms other than Bonita Springs-Estero REALTORS&reg; may be marked with
      the Internet Data Exchange logo and detailed information about those properties will include the name of the
      listing broker(s) when required by the MLS. All rights reserved.</p>
  </footer>

  <!-- Bottom Sheet (Mobile) -->
  <div class="bottom-sheet collapsed" id="bottomSheet">
    <div class="bottom-sheet-handle" id="bottomSheetHandle"></div>
    <div class="bottom-sheet-header">
      <h3 id="mobileResultsTitle">0 results</h3>
      <span>View search stats</span>
    </div>
    <div class="bottom-sheet-content">
      <div class="listings-grid" id="mobileListingsGrid"></div>
    </div>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active">
      <i class="fas fa-search"></i>
      <span>Search</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-users"></i>
      <span>Clients</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-comment-dots"></i>
      <span>Chat</span>
    </a>
    <a href="#" class="nav-item">
      <i class="fas fa-route"></i>
      <span>Tours</span>
    </a>
    <a href="#" class="nav-item">
      <i class="far fa-user"></i>
      <span>Account</span>
    </a>
  </div>

  <!-- Saved Cart FAB -->
  <button class="cart-fab" id="cartFab" title="Saved Listings"><i class="fas fa-heart"></i><span class="cart-badge"
      id="cartBadge" style="display:none">0</span></button>
  <div class="cart-panel" id="cartPanel">
    <div class="cart-header">
      <h3><i class="fas fa-heart" style="color:var(--hot);margin-right:6px"></i>Saved Listings</h3><button
        class="cart-clear" id="cartClear">Clear All</button>
    </div>
    <div class="cart-items" id="cartItems">
      <div class="cart-empty">No saved listings yet</div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="detail-overlay" id="detailOverlay">
    <div class="detail-modal">
      <button class="detail-close" id="detailClose">&times;</button>
      <div class="detail-gallery" id="detailGallery">
        <img class="detail-gallery-img" id="detailMainImg" src="">
        <button class="detail-gallery-nav prev" onclick="detailNav(-1)">&#10094;</button>
        <button class="detail-gallery-nav next" onclick="detailNav(1)">&#10095;</button>
        <div class="detail-gallery-count" id="detailImgCount"></div>
      </div>
      <div class="detail-gallery-thumbs" id="detailThumbs"></div>
      <div class="detail-body">
        <div class="detail-actions">
          <button class="detail-save-btn" id="detailSaveBtn" onclick="toggleSaveFromDetail()"><i
              class="fas fa-heart"></i> Save</button>
        </div>
        <div class="detail-price" id="detailPrice"></div>
        <div class="detail-addr" id="detailAddr"></div>
        <div class="detail-badges" id="detailBadges"></div>
        <div class="detail-stats" id="detailStats"></div>
        <div class="detail-description" id="detailDesc"></div>
        <div class="detail-agent-section" id="detailAgentSection">
          <div class="detail-agent-name" id="detailAgentName"></div>
          <div class="detail-agent-office" id="detailAgentOffice"></div>
          <div class="detail-agent-btns">
            <button class="detail-agent-btn primary" id="detailContactBtn"><i class="fas fa-envelope"></i> Contact
              Agent</button>
            <button class="detail-agent-btn outline" id="detailViewAgentBtn"><i class="fas fa-user"></i> View Agent
              Listings</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="contact-overlay" id="contactOverlay">
    <div class="contact-modal">
      <button class="contact-close" id="contactClose">&times;</button>
      <h3>Contact Agent</h3>
      <div class="sub" id="contactAgentLabel"></div>
      <form class="contact-form" id="contactForm">
        <label>Your Name</label><input type="text" id="contactName" required>
        <label>Your Email</label><input type="email" id="contactEmail" required>
        <label>Your Phone (optional)</label><input type="tel" id="contactPhone">
        <label>Message</label><textarea id="contactMessage"></textarea>
        <button type="submit" class="send-btn"><i class="fas fa-paper-plane"></i> Send Email</button>
      </form>
    </div>
  </div>

  <!-- Agent Modal -->
  <div class="agent-modal-overlay" id="agentModalOverlay">
    <div class="agent-modal">
      <div class="agent-modal-header">
        <button class="agent-modal-close" id="agentModalClose">&times;</button>
        <div class="agent-name" id="agentName"></div>
        <div class="agent-office" id="agentOffice"></div>
      </div>
      <div class="agent-listings-grid" id="agentListingsGrid"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script>
    const API_BASE = 'https://listingsworker.bonitaspringsrealtors.workers.dev';
    const SEL = 'ListingKey,UnparsedAddress,City,ListPrice,BedroomsTotal,BathroomsTotalInteger,LivingArea,Coordinates,ListingContractDate,StatusChangeTimestamp,PropertyType,PropertySubType,StandardStatus,ListAgentKey,ListAgentFullName,ListOfficeName,ListAgentEmail,PublicRemarks,YearBuilt,LotSizeAcres';
    let map, markers = [], allListings = [], totalListingCount = 0, mediaCache = new Map(), currentPropertyType = 'sale', currentStatus = 'Active', currentDetail = null;
    const fmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const kFmt = (n) => { if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'm'; if (n >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'k'; return '$' + n; };
    // Saved cart
    let savedListings = JSON.parse(localStorage.getItem('savedListings') || '[]');
    let markerCluster;

    function initMap() {
      map = L.map('map').setView([26.34, -81.78], 12);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);
      markerCluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        maxClusterRadius: 40,
        iconCreateFunction: function (cluster) {
          const count = cluster.getChildCount();
          let level = 'small';
          if (count > 10) level = 'medium';
          if (count > 50) level = 'large';
          return L.divIcon({
            html: '<div>' + count + '</div>',
            className: 'marker-cluster marker-cluster-' + level,
            iconSize: L.point(40, 40)
          });
        }
      });
      map.addLayer(markerCluster);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      setupPills('#propertyTypePills', b => {
        currentPropertyType = b.dataset.type;
        const subTypeBtn = document.getElementById('subTypeBtn');
        if (currentPropertyType === 'commercial' || currentPropertyType === 'land') {
          subTypeBtn.style.opacity = '0.5';
          subTypeBtn.style.pointerEvents = 'none';
          subTypeBtn.innerText = 'Home Type (N/A)';
        } else {
          subTypeBtn.style.opacity = '1';
          subTypeBtn.style.pointerEvents = 'auto';
          updateFilterLabels(); // Restore label
        }
        fetchListings();
      });

      setupFilters();
      updateFilterLabels();
      setupSearch();
      setupMobileUI();
      fetchListings();
      updateDisclaimerDates();
      checkUrlParams();

      // Scroll arrows
      const fb = document.getElementById('filtersBar');
      document.getElementById('filterLeft').onclick = () => fb.scrollBy({ left: -200, behavior: 'smooth' });
      document.getElementById('filterRight').onclick = () => fb.scrollBy({ left: 200, behavior: 'smooth' });
      // Cart FAB
      document.getElementById('cartFab').onclick = () => { const p = document.getElementById('cartPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; };
      document.getElementById('cartClear').onclick = () => { savedListings = []; localStorage.setItem('savedListings', '[]'); updateCartUI(); };
      // Detail close
      document.getElementById('detailClose').onclick = () => document.getElementById('detailOverlay').style.display = 'none';
      document.getElementById('detailOverlay').onclick = e => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; };
      // Agent modal close
      document.getElementById('agentModalClose').onclick = () => document.getElementById('agentModalOverlay').style.display = 'none';
      document.getElementById('agentModalOverlay').onclick = e => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; };
      // Contact close
      document.getElementById('contactClose').onclick = () => document.getElementById('contactOverlay').style.display = 'none';
      document.getElementById('contactOverlay').onclick = e => { if (e.target === e.currentTarget) e.currentTarget.style.display = 'none'; };
      // Contact form
      document.getElementById('contactForm').onsubmit = e => {
        e.preventDefault();
        if (!currentDetail || !currentDetail.ListAgentEmail) return;
        const name = document.getElementById('contactName').value;
        const email = document.getElementById('contactEmail').value;
        const phone = document.getElementById('contactPhone').value;
        const msg = document.getElementById('contactMessage').value;
        const subject = encodeURIComponent(`Inquiry about ${currentDetail.UnparsedAddress || 'property'}`);
        const body = encodeURIComponent(`Hi ${currentDetail.ListAgentFullName || ''},\n\n${msg}\n\nRegarding: ${currentDetail.UnparsedAddress || ''}\nListed at: ${fmt.format(currentDetail.ListPrice || 0)}\n\nFrom: ${name}\nEmail: ${email}${phone ? '\nPhone: ' + phone : ''}`);
        window.open(`mailto:${currentDetail.ListAgentEmail}?subject=${subject}&body=${body}`, '_blank');
        document.getElementById('contactOverlay').style.display = 'none';
      };
    });

    function setupPills(sel, cb) {
      document.querySelectorAll(sel + ' .pill-btn').forEach(b => b.onclick = () => {
        document.querySelectorAll(sel + ' .pill-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active'); cb(b);
      });
    }

    function setupFilters() {
      // Generic Dropdown Toggles
      // Generic Dropdown Toggles - FIXED POSITIONING
      document.querySelectorAll('.filter-dropdown-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const p = btn.nextElementSibling;
          // Close others
          document.querySelectorAll('.filter-dropdown-panel').forEach(x => {
            if (x !== p) { x.classList.remove('open'); x.style.display = 'none'; }
          });

          if (p.classList.contains('open')) {
            p.classList.remove('open'); p.style.display = 'none';
          } else {
            // Calculate fixed position
            const rect = btn.getBoundingClientRect();
            p.style.position = 'fixed';
            p.style.top = (rect.bottom + 4) + 'px';
            p.style.left = Math.max(10, rect.left) + 'px';
            p.style.minWidth = '200px';
            p.style.zIndex = '10001';
            p.style.display = 'block';

            // Adjust if off screen right
            if (rect.left + 220 > window.innerWidth) {
              p.style.left = 'auto';
              p.style.right = '10px';
            }
            p.classList.add('open');
          }
        });
      });

      // Close on outside click or scroll
      const closeAll = () => document.querySelectorAll('.filter-dropdown-panel').forEach(p => { p.classList.remove('open'); p.style.display = 'none'; });
      document.addEventListener('click', closeAll);
      document.addEventListener('scroll', closeAll, true); // True to capture all scrolls
      window.addEventListener('resize', closeAll);
      document.querySelectorAll('.filter-dropdown-panel').forEach(p => p.addEventListener('click', e => e.stopPropagation()));

      // Button Groups (Beds/Baths)
      document.querySelectorAll('.filter-option-btn').forEach(b => {
        b.addEventListener('click', () => {
          b.parentElement.querySelectorAll('.filter-option-btn').forEach(x => x.classList.remove('selected'));
          b.classList.add('selected');
        });
      });

      // Apply Buttons
      document.querySelectorAll('.apply-btn').forEach(b => {
        b.addEventListener('click', () => {
          b.closest('.filter-dropdown-panel').classList.remove('open');
          updateFilterLabels();
          applyClientFilters();
        });
      });

      // Special handling for beds/baths buttons (no apply needed if you want immediate, but user added Apply to others)
      // I'll add Apply buttons to Beds/Baths for consistency as per my plan above.

      // Clear Filters
      document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    }

    function updateFilterLabels() {
      // Price
      const min = document.getElementById('priceMin').value, max = document.getElementById('priceMax').value;
      const pb = document.getElementById('priceBtn');
      if (min || max) { pb.classList.add('has-value'); pb.innerText = (min ? '$' + kFmt(min) + '+' : '') + (min && max ? '-' : '') + (max ? '<$' + kFmt(max) : ''); }
      else { pb.classList.remove('has-value'); pb.innerText = 'Price'; }

      // SubType
      const st = Array.from(document.querySelectorAll('#subTypePanel input:checked')).map(i => i.value);
      const sb = document.getElementById('subTypeBtn');
      if (st.length && st.length < 5) { sb.classList.add('has-value'); sb.innerText = st.length + ' Home Types'; } // Adjusted logic
      else { sb.classList.remove('has-value'); sb.innerText = 'Home Type'; }

      // Beds
      const bd = document.querySelector('#bedsGroup .selected').dataset.val;
      const bdB = document.getElementById('bedsBtn');
      if (bd > 0) { bdB.classList.add('has-value'); bdB.innerText = bd + '+ Beds'; }
      else { bdB.classList.remove('has-value'); bdB.innerText = 'Beds'; }

      // Baths
      const ba = document.querySelector('#bathsGroup .selected').dataset.val;
      const baB = document.getElementById('bathsBtn');
      if (ba > 0) { baB.classList.add('has-value'); baB.innerText = ba + '+ Baths'; }
      else { baB.classList.remove('has-value'); baB.innerText = 'Baths'; }

      // City
      const ct = Array.from(document.querySelectorAll('#cityPanel input:checked')).map(i => i.value);
      const cb = document.getElementById('cityBtn');
      if (ct.length) { cb.classList.add('has-value'); cb.innerText = ct.length === 1 ? ct[0] : ct.length + ' Cities'; }
      else { cb.classList.remove('has-value'); cb.innerText = 'City'; }

      // Sort
      const so = document.querySelector('input[name="sort"]:checked').value;
      const sob = document.getElementById('sortBtn');
      if (so !== 'dateDesc') { sob.classList.add('has-value'); sob.innerText = so === 'priceDesc' ? 'Price High-Low' : 'Price Low-High'; }
      else { sob.classList.remove('has-value'); sob.innerText = 'Sort'; }
    }

    function clearFilters() {
      document.getElementById('priceMin').value = '';
      document.getElementById('priceMax').value = '';
      document.querySelectorAll('#subTypePanel input').forEach(i => i.checked = true);
      document.querySelectorAll('#cityPanel input').forEach(i => {
        if (i.value === 'Bonita Springs' || i.value === 'Estero') i.checked = true;
        else i.checked = false;
      });
      document.querySelectorAll('.filter-option-btn.selected').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#bedsGroup .filter-option-btn[data-val="0"]').forEach(b => b.classList.add('selected'));
      document.querySelectorAll('#bathsGroup .filter-option-btn[data-val="0"]').forEach(b => b.classList.add('selected'));
      document.querySelector('input[name="sort"][value="dateDesc"]').checked = true;
      document.getElementById('searchInput').value = '';
      updateFilterLabels();
      applyClientFilters();
    }

    function setupSearch() {
      const inp = document.getElementById('searchInput');
      const minp = document.getElementById('mobileSearchInput');

      const handleSearch = (v) => {
        const q = v.trim();
        document.getElementById('searchInput').value = q;
        document.getElementById('mobileSearchInput').value = q;
        applyClientFilters();
        if (q.length > 2) searchFullDatabase(q);
      };

      inp.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(inp.value); });
      minp.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(minp.value); });
    }

    function setupMobileUI() {
      const sheet = document.getElementById('bottomSheet');
      const handle = document.getElementById('bottomSheetHandle');
      let isDragging = false, startY, startTr;

      handle.addEventListener('click', () => {
        sheet.classList.toggle('collapsed');
      });

      // Simple drag logic
      handle.addEventListener('touchstart', e => {
        isDragging = true;
        startY = e.touches[0].clientY;
        startTr = sheet.getBoundingClientRect().top;
      });

      document.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const delta = e.touches[0].clientY - startY;
        if (delta < -50) sheet.classList.remove('collapsed');
        if (delta > 50) sheet.classList.add('collapsed');
      });

      document.addEventListener('touchend', () => isDragging = false);
    }

    let fetchedContexts = new Set(); // Tracks "Status|Type" combinations fully loaded

    async function fetchListings() {
      // Context Key
      const contextKey = currentStatus + '|' + currentPropertyType;

      // Clear fetched contexts to force a fresh fetch if we are switching types/status
      // meaningful only if we were caching, but since we are clearing allListings, we should clear this too for clarity
      fetchedContexts.clear();

      // If switching context (Type/Status), we MUST clear previous data to avoid mixing
      // We only use cache if we are NOT switching context, or if we want to restore a previous context
      // actually, for simplicity, let's just clear and re-fetch if context changes for now to ensure correctness

      // Reset logic
      allListings = [];
      totalListingCount = 0;
      markers.forEach(m => m.remove());
      markers = [];
      if (markerCluster) markerCluster.clearLayers();
      document.getElementById('listingsGrid').innerHTML = '';
      document.getElementById('capBanner').style.display = 'none';

      showLoading(true);
      const loader = document.getElementById('listLoader');
      if (loader) loader.style.display = 'inline-block';

      const MAX_LISTINGS = 500;

      try {
        // Status Logic
        let statusFilter = "StandardStatus eq '" + currentStatus + "'";
        if (currentStatus === 'Pending') statusFilter = "(StandardStatus eq 'Pending' or StandardStatus eq 'Active Under Contract')";
        else if (currentStatus === 'Closed') statusFilter = "StandardStatus eq 'Closed'";

        // Base Filter
        let baseF = "OriginatingSystemKey eq 'bsaor' and " + statusFilter;
        baseF += " and (City eq 'BONITA SPRINGS' or City eq 'ESTERO')";

        if (currentPropertyType === 'sale') {
          baseF += " and (PropertyType eq 'Residential' or PropertyType eq 'Residential Income')";
        } else if (currentPropertyType === 'rental') {
          baseF += " and (PropertyType eq 'Residential Lease')";
        } else if (currentPropertyType === 'commercial') {
          baseF += " and (PropertyType eq 'Commercial Sale' or PropertyType eq 'Commercial')";
        } else if (currentPropertyType === 'land') {
          baseF += " and (PropertyType eq 'Land')";
        }

        // Get total count (non-blocking)
        const countParams = new URLSearchParams();
        countParams.append('$filter', baseF);
        countParams.append('$top', 0);
        countParams.append('$count', 'true');
        fetch(API_BASE + '/api/v2/OData/bsaor/Property?' + countParams)
          .then(r => r.json())
          .then(d => { totalListingCount = d['@odata.count'] || d.value?.length || 0; })
          .catch(() => { });

        let hasMore = true;
        let skip = 0;
        let lastPrice = null;
        const BATCH = 200;

        while (hasMore && allListings.length < MAX_LISTINGS) {
          const p = new URLSearchParams();
          let f = baseF;
          if (lastPrice !== null) f += " and ListPrice le " + lastPrice;

          const remaining = MAX_LISTINGS - allListings.length;
          p.append('$filter', f);
          p.append('$select', SEL);
          p.append('$top', Math.min(BATCH, remaining));
          p.append('$skip', skip);
          p.append('$orderby', 'ListPrice desc');

          const r = await fetch(API_BASE + '/api/v2/OData/bsaor/Property?' + p);
          if (!r.ok) throw new Error('API Error ' + r.status);
          const d = await r.json();
          const items = d.value || [];

          if (!items.length) { hasMore = false; break; }

          let added = 0;
          items.forEach(i => {
            if (allListings.length < MAX_LISTINGS && !allListings.some(x => x.ListingKey === i.ListingKey)) {
              allListings.push(i);
              added++;
            }
          });

          if (allListings.length >= MAX_LISTINGS) hasMore = false;
          else if (items.length < BATCH) hasMore = false;
          else {
            const lastItem = items[items.length - 1];
            const newLastPrice = lastItem.ListPrice || 0;
            if (lastPrice !== null && newLastPrice === lastPrice) {
              skip += items.length;
            } else {
              lastPrice = newLastPrice;
              skip = 0;
            }
          }

          const lt = document.getElementById('loadingText');
          if (lt) lt.innerText = `Loading... (${allListings.length} cached)`;

          if (added > 0 && allListings.length >= BATCH && document.getElementById('loadingOverlay').style.display !== 'none') {
            showLoading(false);
            MediaLoader.init();
            renderCarousel(allListings);
            applyClientFilters();
          }

          if (skip > 6000) hasMore = false;
        }

        fetchedContexts.add(contextKey);

        MediaLoader.init();
        renderCarousel(allListings);
        applyClientFilters();

      } catch (e) { console.error(e); document.getElementById('listingsGrid').innerHTML = '<div style="padding:20px;text-align:center;color:red">' + e.message + '</div>'; }
      finally {
        showLoading(false);
        if (loader) loader.style.display = 'none';
      }
    }

    async function searchFullDatabase(q) {
      if (!q || q.length < 3) return;
      showLoading(true);
      try {
        // Try exact ListingKey or Address contains
        const f = "OriginatingSystemKey eq 'bsaor' and (ListingKey eq '" + q + "' or contains(UnparsedAddress, '" + q + "'))";
        const r = await fetch(API_BASE + '/api/v2/OData/bsaor/Property?$filter=' + encodeURIComponent(f) + '&$select=' + SEL + '&$top=20');
        if (!r.ok) throw new Error('Search failed');
        const d = await r.json();
        const newItems = d.value || [];
        if (newItems.length) {
          // Merge new items avoiding duplicates
          newItems.forEach(ni => { if (!allListings.some(x => x.ListingKey === ni.ListingKey)) allListings.push(ni); });
          applyClientFilters();
        } else {
          alert('No specific matches found in database for "' + q + '"');
        }
      } catch (e) { console.error(e); }
      finally { showLoading(false); }
    }

    const MediaLoader = {
      queue: [], processing: false, observer: null, loadedCount: 0,
      init() { if (this.observer) return; this.observer = new IntersectionObserver(es => { es.forEach(e => { if (e.isIntersecting) { const id = e.target.dataset.id; if (id && !mediaCache.has(id)) { this.enqueue(id); this.observer.unobserve(e.target); } } }); }, { rootMargin: '300px' }); },
      observe(el) { if (this.observer) this.observer.observe(el); },
      enqueue(id) { if (!this.queue.includes(id)) { this.queue.push(id); this.process(); } },
      async process() { if (this.processing || !this.queue.length) return; this.processing = true; const ck = this.queue.splice(0, 10); await this.fetchChunk(ck); this.loadedCount += ck.length; if (this.loadedCount >= 8) hideLoadingOverlay(); this.processing = false; if (this.queue.length) this.process(); },
      async fetchChunk(keys) { if (!keys.length) return; const f = keys.map(k => "ListingKey eq '" + k + "'").join(' or '); try { const r = await fetch(API_BASE + '/api/v2/OData/bsaor/Property?$filter=' + encodeURIComponent(f) + '&$select=ListingKey,Media'); if (!r.ok) return; const d = await r.json(); (d.value || []).forEach(p => { if (p.Media && p.Media.length) { const urls = p.Media.sort((a, b) => (a.Order || 0) - (b.Order || 0)).map(m => m.MediaURL || m.MediaUrl || m.MediaURLLarge).filter(Boolean); if (urls.length) { mediaCache.set(p.ListingKey, urls); updImg(p.ListingKey, urls); } } }); } catch (e) { console.warn('ML err', e); } }
    };

    function updImg(k, urls) { ['img-', 'c-img-'].forEach(px => { const i = document.getElementById(px + k); if (i) i.src = urls[0]; }); const c = document.getElementById('count-' + k); if (c) c.innerText = '1/' + urls.length; }

    function renderCarousel(items) {
      const t = document.getElementById('carouselTrack'), w = document.getElementById('carouselsWrapper');
      const now = new Date(), wk = new Date(); wk.setDate(now.getDate() - 7);
      const ni = items.filter(x => x.ListingContractDate && new Date(x.ListingContractDate) >= wk);
      if (!ni.length) { w.style.display = 'none'; return; }
      w.style.display = 'block'; document.getElementById('newCount').textContent = ni.length + ' New';
      const max = Math.max(1, Math.floor((window.innerWidth - 32) / 212));
      t.innerHTML = ''; ni.slice(0, max).forEach(item => {
        const el = document.createElement('div'); el.className = 'carousel-card'; el.dataset.id = item.ListingKey;
        el.innerHTML = '<div class="carousel-img-wrapper"><img src="" id="c-img-' + item.ListingKey + '" class="carousel-img" loading="lazy"><div class="price-badge">' + fmt.format(item.ListPrice || 0) + '</div></div><div class="card-content"><div class="card-address" style="font-size:0.78rem">' + (item.UnparsedAddress || '') + '</div><div class="card-meta">' + (item.City || '') + '</div></div>';
        el.onclick = () => { openDetail(item); };
        t.appendChild(el); MediaLoader.enqueue(item.ListingKey);
      });
    }
    window.addEventListener('resize', () => { if (allListings.length) renderCarousel(allListings); });

    function applyClientFilters() {
      // Read state from inputs
      const sort = document.querySelector('input[name="sort"]:checked').value;
      const cities = Array.from(document.querySelectorAll('#cityPanel input:checked')).map(i => i.value);
      const minP = Number(document.getElementById('priceMin').value) || 0, maxP = Number(document.getElementById('priceMax').value) || Infinity;
      const beds = Number(document.querySelector('#bedsGroup .selected').dataset.val) || 0;
      const baths = Number(document.querySelector('#bathsGroup .selected').dataset.val) || 0;
      const subTypes = Array.from(document.querySelectorAll('#subTypePanel input:checked')).map(i => i.value);
      const q = (document.getElementById('searchInput').value || '').toLowerCase();

      // Client-Side Status Mapping
      const targetStatus = currentStatus === 'Pending' ? ['Pending', 'Active Under Contract'] : [currentStatus];

      let fl = allListings.filter(i => {
        // Status Check
        if (!targetStatus.includes(i.StandardStatus || 'Active')) return false;

        // Type Check (Rough client-side approximation)
        if (currentPropertyType === 'sale' && i.PropertyType === 'Residential Lease') return false;
        // ... (API handles type, this is safety)

        const p = i.ListPrice || 0;
        if (cities.length) {
          const itemCity = (i.City || '').toUpperCase();
          if (!cities.some(c => c.toUpperCase() === itemCity)) return false;
        }
        if (p < minP || p > maxP) return false;
        if ((i.BedroomsTotal || 0) < beds || (i.BathroomsTotalInteger || 0) < baths) return false;

        if ((currentPropertyType === 'sale' || currentPropertyType === 'rental') && subTypes.length) {
          // Map simple UI types to complex API subtypes
          const typeMap = {
            'Single Family Residence': ['Single Family Residence', 'Manufactured Home'],
            'Condominium': ['Condominium', 'High Rise (8+)', 'Mid Rise (4-7)', 'Low Rise (1-3)'],
            'Townhouse': ['Townhouse'],
            'Multi Family': ['Multi Family', 'Duplex', 'Triplex', 'Quadruplex'],
            'Villa': ['Villa Attached', 'Villa Detached']
          };

          let match = false;
          for (const t of subTypes) {
            const allowed = typeMap[t] || [t];
            if (allowed.includes(i.PropertySubType)) { match = true; break; }
          }
          if (!match) return false;
        }
        if (q && !((i.UnparsedAddress || '').toLowerCase().includes(q) || (i.ListingKey || '').toLowerCase().includes(q) || (i.City || '').toLowerCase().includes(q))) return false;
        return true;
      });

      if (sort === 'priceDesc') fl.sort((a, b) => (b.ListPrice || 0) - (a.ListPrice || 0));
      else if (sort === 'priceAsc') fl.sort((a, b) => (a.ListPrice || 0) - (b.ListPrice || 0));
      else fl.sort((a, b) => (b.ListingContractDate || '') > (a.ListingContractDate || '') ? 1 : -1);

      updateUI(fl);
      renderMapMarkers(fl, false, minP, maxP);
      const resText = fl.length + ' Listings';
      document.getElementById('resultsCount').innerText = resText;
      document.getElementById('mobileResultsTitle').innerText = fl.length + ' results';

      // Show cap banner if we hit the limit
      const banner = document.getElementById('capBanner');
      const bannerText = document.getElementById('capBannerText');
      if (totalListingCount > allListings.length) {
        banner.style.display = 'block';
        bannerText.innerText = `Showing ${fl.length} of ${totalListingCount.toLocaleString()} listings  Add search criteria to narrow results`;
      } else {
        banner.style.display = 'none';
      }
    }
  </script>
  <script>
    function updateUI(listings) {
      const grid = document.getElementById('listingsGrid');
      const mGrid = document.getElementById('mobileListingsGrid');
      grid.innerHTML = '';
      if (mGrid) mGrid.innerHTML = '';
      const minP = Number(document.getElementById('priceMin').value) || 0, maxP = Number(document.getElementById('priceMax').value) || 0;
      const heat = minP > 0 && maxP > minP;
      listings.forEach(item => {
        const card = document.createElement('div'); card.className = 'listing-card'; card.id = 'card-' + item.ListingKey;
        const cached = mediaCache.get(item.ListingKey); let imgUrl = '', pc = 0;
        if (cached && cached.length) { imgUrl = cached[0]; pc = cached.length; }
        const sc = item.StandardStatus === 'Pending' ? 'pending' : item.StandardStatus === 'Active Under Contract' ? 'auc' : 'active';
        const sl = item.StandardStatus === 'Active Under Contract' ? 'Under Contract' : item.StandardStatus || 'Active';
        const isSaved = savedListings.some(s => s.key === item.ListingKey);
        card.innerHTML = `<div class="card-img-wrapper">
          <img src="${imgUrl}" id="img-${item.ListingKey}" class="card-img" loading="lazy" data-index="0">
          <div class="price-badge">${fmt.format(item.ListPrice || 0)}</div>
          <div class="status-badge-card ${sc}">${sl}</div>
          <button class="card-save-btn ${isSaved ? 'saved' : ''}" data-key="${item.ListingKey}" onclick="event.stopPropagation();toggleSave('${item.ListingKey}')"><i class="fas fa-heart"></i></button>
          <button class="card-arrow left" onclick="event.stopPropagation();chImg(event,'${item.ListingKey}',-1)">&#10094;</button>
          <button class="card-arrow right" onclick="event.stopPropagation();chImg(event,'${item.ListingKey}',1)">&#10095;</button>
          <div class="photo-count" id="count-${item.ListingKey}">${pc ? '1/' + pc : ''}</div>
        </div><div class="card-content">
          ${item.PropertySubType ? '<div class="card-subtype">' + item.PropertySubType + '</div>' : ''}
          <div class="card-address">${item.UnparsedAddress || 'Unknown'}</div>
          <div class="card-details">
            <span class="card-detail-item"><i class="fas fa-bed"></i> ${item.BedroomsTotal || 0}</span>
            <span class="card-detail-item"><i class="fas fa-bath"></i> ${item.BathroomsTotalInteger || 0}</span>
            <span class="card-detail-item"><i class="fas fa-ruler-combined"></i> ${(item.LivingArea || 0).toLocaleString()} sqft</span>
          </div>
          <div class="card-meta"><span>${item.City || ''}</span><span>${item.ListAgentFullName || ''}</span></div>
        </div>`;
        card.dataset.id = item.ListingKey;
        card.addEventListener('mouseenter', () => highlightMarker(item.ListingKey, true));
        card.addEventListener('mouseleave', () => highlightMarker(item.ListingKey, false));
        card.addEventListener('click', () => openDetail(item));

        grid.appendChild(card);
        if (mGrid) {
          const mCard = card.cloneNode(true);
          mCard.onclick = () => openDetail(item);
          mGrid.appendChild(mCard);
        }
        MediaLoader.observe(card);
      });
      renderMapMarkers(listings, heat, minP, maxP);
    }

    function chImg(e, key, dir) {
      e.stopPropagation(); e.preventDefault();
      const urls = mediaCache.get(key); if (!urls || !urls.length) return;
      const img = document.getElementById('img-' + key), ct = document.getElementById('count-' + key); if (!img) return;
      let idx = parseInt(img.dataset.index || '0') + dir; if (idx < 0) idx = urls.length - 1; if (idx >= urls.length) idx = 0;
      img.src = urls[idx]; img.dataset.index = idx; if (ct) ct.innerText = (idx + 1) + '/' + urls.length;
    }

    // --- Detail Modal ---
    let detailIdx = 0;
    function openDetail(item) {
      currentDetail = item; detailIdx = 0;
      const ov = document.getElementById('detailOverlay'); ov.style.display = 'block';
      const urls = mediaCache.get(item.ListingKey) || [];
      const mainImg = document.getElementById('detailMainImg');
      mainImg.src = urls[0] || '';
      document.getElementById('detailImgCount').textContent = urls.length ? (1 + '/' + urls.length) : '';
      // Thumbs
      const thumbs = document.getElementById('detailThumbs'); thumbs.innerHTML = '';
      urls.slice(0, 20).forEach((u, i) => {
        const t = document.createElement('img'); t.className = 'detail-thumb' + (i === 0 ? ' active' : ''); t.src = u;
        t.onclick = () => {
          detailIdx = i; mainImg.src = u; document.getElementById('detailImgCount').textContent = (i + 1) + '/' + urls.length;
          thumbs.querySelectorAll('.detail-thumb').forEach(x => x.classList.remove('active')); t.classList.add('active');
        };
        thumbs.appendChild(t);
      });
      document.getElementById('detailPrice').textContent = fmt.format(item.ListPrice || 0);
      document.getElementById('detailAddr').textContent = (item.UnparsedAddress || '') + ', ' + (item.City || '');
      // Badges
      const badges = document.getElementById('detailBadges'); badges.innerHTML = '';
      const addBadge = (txt, bg) => { const b = document.createElement('span'); b.className = 'detail-badge'; b.style.background = bg; b.style.color = '#fff'; b.textContent = txt; badges.appendChild(b); };
      addBadge(item.StandardStatus || 'Active', item.StandardStatus === 'Pending' ? 'var(--pending)' : item.StandardStatus === 'Active Under Contract' ? 'var(--warning)' : 'var(--success)');
      if (item.PropertySubType) addBadge(item.PropertySubType, 'var(--primary)');
      if (item.PropertyType) addBadge(item.PropertyType, '#666');
      // Stats
      const stats = document.getElementById('detailStats'); stats.innerHTML = '';
      const addStat = (icon, txt) => { stats.innerHTML += `<div class="detail-stat"><i class="fas fa-${icon}"></i>${txt}</div>`; };
      if (item.BedroomsTotal) addStat('bed', item.BedroomsTotal + ' Beds');
      if (item.BathroomsTotalInteger) addStat('bath', item.BathroomsTotalInteger + ' Baths');
      if (item.LivingArea) addStat('ruler-combined', (item.LivingArea).toLocaleString() + ' sqft');
      if (item.YearBuilt) addStat('calendar', 'Built ' + item.YearBuilt);
      if (item.LotSizeAcres) addStat('tree', item.LotSizeAcres + ' acres');
      // Description
      document.getElementById('detailDesc').textContent = item.PublicRemarks || 'No description available.';
      // Agent
      document.getElementById('detailAgentName').textContent = item.ListAgentFullName || 'Unknown Agent';
      document.getElementById('detailAgentOffice').textContent = item.ListOfficeName || '';
      // Contact button
      const contactBtn = document.getElementById('detailContactBtn');
      contactBtn.onclick = () => openContact(item);
      contactBtn.style.display = item.ListAgentEmail ? '' : 'none';
      // View agent button
      document.getElementById('detailViewAgentBtn').onclick = () => {
        document.getElementById('detailOverlay').style.display = 'none';
        openAgentModal(item.ListAgentKey, item.ListAgentFullName || '', item.ListOfficeName || '');
      };
      // Save state
      const sb = document.getElementById('detailSaveBtn');
      const isSaved = savedListings.some(s => s.key === item.ListingKey);
      sb.className = 'detail-save-btn' + (isSaved ? ' saved' : '');
      sb.innerHTML = '<i class="fas fa-heart"></i> ' + (isSaved ? 'Saved' : 'Save');
      // Pan map
      let lat, lng; if (item.Coordinates && item.Coordinates.length === 2) { lng = item.Coordinates[0]; lat = item.Coordinates[1]; }
      if (lat && lng) map.flyTo([lat, lng], 16);
    }
    function detailNav(dir) {
      if (!currentDetail) return;
      const urls = mediaCache.get(currentDetail.ListingKey) || []; if (!urls.length) return;
      detailIdx += dir; if (detailIdx < 0) detailIdx = urls.length - 1; if (detailIdx >= urls.length) detailIdx = 0;
      document.getElementById('detailMainImg').src = urls[detailIdx];
      document.getElementById('detailImgCount').textContent = (detailIdx + 1) + '/' + urls.length;
      const thumbs = document.getElementById('detailThumbs').querySelectorAll('.detail-thumb');
      thumbs.forEach((t, i) => { t.classList.toggle('active', i === detailIdx); });
    }

    // --- Contact ---
    function openContact(item) {
      currentDetail = item;
      document.getElementById('contactOverlay').style.display = 'block';
      document.getElementById('contactAgentLabel').textContent = (item.ListAgentFullName || 'Agent') + '  ' + (item.ListOfficeName || '');
      document.getElementById('contactMessage').value = 'I am interested in the property at ' + (item.UnparsedAddress || '') + ' listed at ' + fmt.format(item.ListPrice || 0) + '. Please contact me with more information.';
    }

    // --- Saved Cart ---
    function toggleSave(key) {
      const idx = savedListings.findIndex(s => s.key === key);
      if (idx >= 0) { savedListings.splice(idx, 1); }
      else { const item = allListings.find(i => i.ListingKey === key); if (item) { const urls = mediaCache.get(key); savedListings.push({ key: key, addr: item.UnparsedAddress || '', price: item.ListPrice || 0, img: urls && urls.length ? urls[0] : '' }); } }
      localStorage.setItem('savedListings', JSON.stringify(savedListings)); updateCartUI();
      // Update button states
      const btn = document.querySelector('.card-save-btn[data-key="' + key + '"]'); if (btn) btn.classList.toggle('saved');
    }
    function toggleSaveFromDetail() {
      if (!currentDetail) return; toggleSave(currentDetail.ListingKey);
      const sb = document.getElementById('detailSaveBtn'); const isSaved = savedListings.some(s => s.key === currentDetail.ListingKey);
      sb.className = 'detail-save-btn' + (isSaved ? ' saved' : ''); sb.innerHTML = '<i class="fas fa-heart"></i> ' + (isSaved ? 'Saved' : 'Save');
    }
    function updateCartUI() {
      const badge = document.getElementById('cartBadge');
      badge.style.display = savedListings.length ? 'flex' : 'none'; badge.textContent = savedListings.length;
      const items = document.getElementById('cartItems');
      if (!savedListings.length) { items.innerHTML = '<div class="cart-empty">No saved listings yet.<br>Click the <i class="fas fa-heart"></i> on listings to save them.</div>'; return; }
      items.innerHTML = '';
      savedListings.forEach(s => {
        const el = document.createElement('div'); el.className = 'cart-item';
        el.innerHTML = `${s.img ? '<img src="' + s.img + '" class="cart-item-img">' : '<div class="cart-item-img"></div>'}
          <div class="cart-item-info"><div class="cart-item-price">${fmt.format(s.price)}</div><div class="cart-item-addr">${s.addr}</div></div>
          <button class="cart-item-remove" onclick="event.stopPropagation();toggleSave('${s.key}')"><i class="fas fa-times"></i></button>`;
        el.onclick = () => { const item = allListings.find(i => i.ListingKey === s.key); if (item) openDetail(item); document.getElementById('cartPanel').style.display = 'none'; };
        items.appendChild(el);
      });
    }

    // --- Map ---
    function renderMapMarkers(listings, heat, minP, maxP) {
      if (markers.length) {
        markerCluster.clearLayers();
      }
      markers = [];
      listings.forEach(item => {
        let lat, lng;
        if (item.Coordinates && item.Coordinates.length === 2) {
          lng = Number(item.Coordinates[0]);
          lat = Number(item.Coordinates[1]);
        } else if (item.Latitude && item.Longitude) {
          lat = Number(item.Latitude);
          lng = Number(item.Longitude);
        }
        if (isNaN(lat) || isNaN(lng)) return;
        const price = item.ListPrice || 0;
        let color = '#22c55e', border = '#16a34a', text = '#fff'; // Green as default for "Active"

        if (item.StandardStatus === 'Pending' || item.StandardStatus === 'Active Under Contract') {
          color = '#8b5cf6'; border = '#7c3aed';
        }

        if (heat && minP && maxP) {
          const ratio = Math.min(1, Math.max(0, (price - minP) / (maxP - minP)));
          const r = Math.round(34 + ratio * (239 - 34));
          const g = Math.round(197 - ratio * (197 - 68));
          const b = Math.round(94 - ratio * (94 - 68));
          color = `rgb(${r},${g},${b})`;
          border = `rgb(${Math.max(0, r - 40)},${Math.max(0, g - 40)},${Math.max(0, b - 40)})`;
        }

        const icon = L.divIcon({
          className: 'custom-pin',
          html: `<div class="price-pin" style="background:${color};border-color:${border};color:${text};display:block;min-width:40px;text-align:center;border-radius:6px;font-weight:700;padding:2px 4px;font-size:11px">${kFmt(price)}</div>`,
          iconSize: [54, 26], iconAnchor: [27, 26]
        });

        const m = L.marker([lat, lng], { icon, zIndexOffset: 1000 });
        m.listingKey = item.ListingKey;

        m.bindPopup(() => {
          const cached = mediaCache.get(item.ListingKey);
          let imgHtml = '';
          if (cached && cached.length) imgHtml = `<img src="${cached[0]}" class="popup-img">`;
          else {
            MediaLoader.enqueue(item.ListingKey);
            setTimeout(() => {
              const c = mediaCache.get(item.ListingKey);
              if (c && c.length) {
                const img = document.querySelector('.leaflet-popup-content .popup-img');
                if (img) img.src = c[0];
              }
            }, 800);
            imgHtml = `<img src="" class="popup-img">`;
          }
          return `<div class="popup-content">
            ${imgHtml}
            <div class="popup-info">
              <div class="popup-price">${fmt.format(price)}</div>
              <div class="popup-address">${item.UnparsedAddress}</div>
              <div class="popup-details">
                <span>${item.BedroomsTotal} bd</span>
                <span>${item.BathroomsTotalInteger} ba</span>
                <span>${(item.LivingArea || 0).toLocaleString()} sqft</span>
              </div>
              <button class="popup-btn" onclick="openDetailByKey('${item.ListingKey}')">View Details</button>
            </div>
          </div>`;
        });
        m.on('mouseover', function () { this.openPopup(); });
        m.on('click', () => {
          const c = document.getElementById('card-' + item.ListingKey);
          if (c) {
            c.scrollIntoView({ behavior: 'smooth', block: 'center' });
            c.classList.add('active');
            setTimeout(() => c.classList.remove('active'), 2000);
          }
          // If on mobile, expand sheet
          if (window.innerWidth < 900) {
            const sheet = document.getElementById('bottomSheet');
            sheet.classList.remove('collapsed');
            const mc = document.querySelector('#mobileListingsGrid #card-' + item.ListingKey);
            if (mc) mc.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
        markerCluster.addLayer(m);
        markers.push(m);
      });
      if (markers.length) map.fitBounds(markerCluster.getBounds().pad(0.1));
    }
    function openContactByKey(k) { const item = allListings.find(i => i.ListingKey === k); if (item) openContact(item); }
    function openDetailByKey(key) { const item = allListings.find(i => i.ListingKey === key); if (item) openDetail(item); }

    function checkUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const mls = params.get('mls');
      if (mls) {
        fetchListingByMls(mls);
      }
    }

    async function fetchListingByMls(mlsId) {
      showLoading(true);
      try {
        const url = `${API_BASE}/api/v2/OData/bsaor/Property?$filter=ListingId eq '${mlsId}'&$select=${SEL}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();
        const item = data.value && data.value[0];

        if (item) {
          // Fetch media separately
          await MediaLoader.fetchChunk([item.ListingKey]);
          openDetail(item);
        } else {
          console.warn('Listing not found:', mlsId);
        }
      } catch (err) {
        console.error('Error fetching deep-linked listing:', err);
      } finally {
        showLoading(false);
      }
    }

    function esc(s) { return s.replace(/'/g, "\\'"); }
    function heatC(r) { return 'rgb(' + Math.round(59 + r * 180) + ',' + Math.round(130 - r * 62) + ',' + Math.round(246 - r * 178) + ')'; }
    function highlightMarker(k, a) { const mk = markers.find(m => m.listingKey === k); if (!mk) return; const el = mk.getElement(); if (!el) return; const p = el.querySelector('.price-pin'); if (!p) return; if (a) { p.style.transform = 'scale(1.2)'; p.style.zIndex = '1000'; mk.openPopup(); } else { p.style.transform = ''; p.style.zIndex = ''; mk.closePopup(); } }
    function fmtShort(p) { if (p >= 1e6) return '$' + (p / 1e6).toFixed(1) + 'm'; if (p >= 1e3) return '$' + (p / 1e3).toFixed(0) + 'k'; return '$' + p; }

    // --- Agent Modal ---
    async function openAgentModal(ak, an, on) {
      const ov = document.getElementById('agentModalOverlay'); document.getElementById('agentName').textContent = an; document.getElementById('agentOffice').textContent = on;
      const grid = document.getElementById('agentListingsGrid'); grid.innerHTML = '<div style="text-align:center;padding:40px;color:#888;grid-column:1/-1"><div class="spinner" style="margin:0 auto 10px"></div>Loading...</div>';
      ov.style.display = 'block';
      try {
        const f = "ListAgentKey eq '" + ak + "' and StandardStatus eq 'Active' and OriginatingSystemKey eq 'bsaor'";
        const r = await fetch(API_BASE + '/api/v2/OData/bsaor/Property?$filter=' + encodeURIComponent(f) + '&$select=ListingKey,UnparsedAddress,City,ListPrice,BedroomsTotal,BathroomsTotalInteger,LivingArea,Media&$top=50');
        if (!r.ok) throw new Error('Failed'); const d = await r.json(); const items = d.value || [];
        if (!items.length) { grid.innerHTML = '<div style="padding:40px;text-align:center;color:#888;grid-column:1/-1">No other listings found</div>'; return; }
        grid.innerHTML = ''; items.forEach(item => {
          let iu = ''; if (item.Media && item.Media.length) { const s = item.Media.sort((a, b) => (a.Order || 0) - (b.Order || 0)); iu = s[0].MediaURL || s[0].MediaUrl || s[0].MediaURLLarge || ''; }
          const c = document.createElement('div'); c.className = 'agent-listing-card';
          c.innerHTML = (iu ? '<img src="' + iu + '" class="agent-card-img">' : '<div class="agent-card-img" style="display:flex;align-items:center;justify-content:center;color:#aaa;font-size:0.75rem">No Photo</div>') + '<div class="agent-card-info"><div class="agent-card-price">' + fmt.format(item.ListPrice || 0) + '</div><div class="agent-card-addr">' + (item.UnparsedAddress || '') + '</div><div style="font-size:0.68rem;color:#888;margin-top:2px">' + (item.BedroomsTotal || 0) + ' bd  ' + (item.BathroomsTotalInteger || 0) + ' ba  ' + (item.LivingArea || 0).toLocaleString() + ' sqft</div></div>';
          grid.appendChild(c);
        });
      } catch (e) { grid.innerHTML = '<div style="padding:40px;text-align:center;color:red;grid-column:1/-1">Error loading</div>'; }
    }

    function updateDisclaimerDates() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
      const dayStr = now.toLocaleDateString('en-US', { weekday: 'short' });
      const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', timeZoneName: 'short' });
      const fullDate = `${dayStr} ${dateStr} `;

      const setTxt = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };
      setTxt('lastUpdatedDate', dateStr);
      setTxt('lastChangedDate', dateStr);
      setTxt('deltaUpdated', `${fullDate} ${timeStr} `);
      setTxt('bsUpdated', `${fullDate} ${timeStr}`);
    }

    function showLoading(show) {
      const ml = document.getElementById('mapLoader');
      if (ml) {
        if (show) { ml.classList.remove('hidden'); ml.style.display = 'flex'; }
        else { ml.classList.add('hidden'); setTimeout(() => ml.style.display = 'none', 300); }
      }
      const ll = document.getElementById('listLoader');
      if (ll) ll.style.display = show ? 'inline-block' : 'none';

      // Ensure global overlay is hidden
      const gl = document.getElementById('loadingOverlay');
      if (gl) gl.style.display = 'none';
    }
    function hideLoadingOverlay() { showLoading(false); }
  </script>
</body>

</html>