<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BER Wrap Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* Light / “Day” default */
      --ink: #0f172a;
      --ink-soft: #6b7280;
      --bg-main: #f3f4f6;
  
      --panel: #ffffff;
      --panel-elevated: #ffffff;
      --panel-border: #d1d5db;
  
      /* BER logo colors */
      --accent: #03aae1;      /* teal from logo */
      --accent-soft: #fbbf24; /* sun */
      --accent-muted: #9ca3af;
  
      --danger: #e11d48;
      --success: #16a34a;
  
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
  
      --shadow-xl: 0 20px 50px rgba(15,23,42,0.15);
      --shadow-md: 0 10px 25px rgba(15,23,42,0.12);
  
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                  "Segoe UI", sans-serif;
    }
  
    * {
      box-sizing: border-box;
    }
  
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-main);
      color: var(--ink);
      font-family: var(--font-sans);
      height: 100%;
    }
  
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
  
    /* Night mode – basically your current look */
    body[data-theme="dark"] {
      --ink: #e5e7eb;
      --ink-soft: #9ca3af;
      --bg-main: radial-gradient(circle at top left, #111827 0, #020617 45%, #000 100%);
  
      --panel: #020617;
      --panel-elevated: #020617;
      --panel-border: #1f2937;
  
      --shadow-xl: 0 25px 60px rgba(0,0,0,0.65);
      --shadow-md: 0 12px 30px rgba(0,0,0,0.45);
    }
  
    .app-shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 16px 16px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
  
    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      background: var(--panel-elevated);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--panel-border);
    }
  
    .branding {
      display: flex;
      align-items: center;
      gap: 12px;
    }
  
    .branding-mark {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fbbf24, var(--accent) 60%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f9fafb;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.08em;
    }
  
    .branding-text h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
  
    .branding-text span {
      display: block;
      margin-top: 2px;
      font-size: 11px;
      color: var(--ink-soft);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }
  
    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(3,170,225,0.06); /* light, on white */
      border: 1px solid var(--panel-border);
      font-size: 12px;
      color: var(--ink-soft);
    }
  
    body[data-theme="dark"] .user-pill {
      background: rgba(15,23,42,0.9);
      border-color: rgba(148,163,184,0.4);
    }
  
    .user-pill button {
      border: none;
      background: rgba(248,250,252,0.06);
      color: var(--ink);
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      cursor: pointer;
    }
  
    .user-pill button:hover {
      background: rgba(248,250,252,0.18);
    }
  
    main.app-main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
  
    .panel {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--panel-border);
      box-shadow: var(--shadow-xl);
      padding: 12px 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
    }
  
    .panel-title {
      font-size: 13px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }
  
    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--ink-soft);
    }
  
    .chip-accent {
      border-color: rgba(248,113,113,0.9);
      color: #fecaca;
    }
  
    /* Calendar */
  
    .calendar-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--ink-soft);
    }
  
    .calendar-controls button {
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--ink);
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }
  
    .calendar-controls button:hover {
      border-color: var(--accent-soft);
    }
  
    .calendar-controls span.month-label {
      font-size: 13px;
      font-weight: 600;
      color: #f9fafb;
    }
  
    .calendar-controls select {
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--ink);
      padding: 3px 8px;
      font-size: 11px;
    }
  
    .calendar-legend {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 11px;
    }
  
    .legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      margin-right: 4px;
      display: inline-block;
    }
  
    .legend-pending { background: rgba(248,250,252,0.26); }
    .legend-inprogress { background: var(--accent-soft); }
    .legend-done { background: var(--success); }
  
    .calendar-grid {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 4px;
      margin-top: 6px;
    }
  
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }
  
    .calendar-weekdays div {
      text-align: center;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }
  
    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }
  
    .day-cell {
      position: relative;
      min-height: 86px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: var(--radius-md);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 4px 4px 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
  
    .day-cell.is-today {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }
  
    .day-cell-empty {
      background: transparent;
      border: none;
      box-shadow: none;
    }
  
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
  
    .day-number {
      font-size: 12px;
      font-weight: 600;
    }
  
    .add-task-btn {
      border: none;
      background: transparent;
      color: var(--ink-soft);
      font-size: 14px;
      cursor: pointer;
      padding: 0 3px;
    }
  
    .add-task-btn:hover {
      color: var(--accent-soft);
    }
  
    .tasks-list {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
  
    .task-pill {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(75,85,99,0.9);
      cursor: pointer;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  
    .task-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      flex-shrink: 0;
    }
  
    .task-status-pending { background: rgba(248,250,252,0.3); }
    .task-status-in_progress { background: var(--accent-soft); }
    .task-status-done { background: var(--success); }
  
    .task-title {
      flex: 1;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  
    .task-assignee {
      font-size: 10px;
      color: var(--ink-soft);
    }
  
    .calendar-metrics {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
    }
  
    #status-pie {
      max-width: 180px;
      max-height: 180px;
    }
  
    /* Goals */
  
    .goals-tabs {
      display: flex;
      gap: 6px;
      border-radius: 999px;
      padding: 2px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 11px;
    }
  
    .goals-tab {
      flex: 1;
      padding: 4px 6px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--ink-soft);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }
  
    .goals-tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #f9fafb;
    }
  
    .goals-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--ink-soft);
      align-items: center;
    }
  
    .goals-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
  
    .goals-controls input[type="month"],
    .goals-controls select,
    .goals-controls input[type="number"] {
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      color: var(--ink);
      padding: 3px 8px;
      font-size: 11px;
    }
  
    .goals-grid {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }
  
    @media (max-width: 1200px) {
      .goals-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  
    @media (max-width: 780px) {
      .goals-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  
    .goal-column {
      border-radius: var(--radius-md);
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.97), rgba(15,23,42,0.99));
      padding: 6px 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
  
    .goal-column-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--ink-soft);
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding-bottom: 4px;
    }
  
    .goal-card {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.97);
      padding: 4px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 2px;
      font-size: 11px;
    }
  
    .goal-card.completed {
      border-color: var(--success);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4);
    }
  
    .goal-row-top {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: center;
    }
  
    .goal-title-input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--ink);
      font-size: 11px;
      font-weight: 500;
      padding: 0;
      outline: none;
    }
  
    .goal-owner-tag {
      font-size: 10px;
      color: var(--ink-soft);
    }
  
    .goal-row-middle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 2px;
    }
  
    .goal-progress {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      font-size: 10px;
      color: var(--ink-soft);
    }
  
    .goal-progress input[type="number"] {
      width: 48px;
      padding: 1px 4px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--ink);
      font-size: 10px;
    }
  
    .goal-done-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      cursor: pointer;
    }
  
    .goal-row-note {
      margin-top: 2px;
    }
  
    .goal-row-note textarea {
      width: 100%;
      min-height: 36px;
      resize: vertical;
      font-size: 10px;
      border-radius: 6px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--ink);
      padding: 2px 4px;
      outline: none;
    }
  
    .goal-add-form {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px dashed rgba(55,65,81,0.8);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
  
    .goal-add-form input,
    .goal-add-form select {
      width: 100%;
      font-size: 10px;
      border-radius: 6px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.9);
      color: var(--ink);
      padding: 2px 4px;
    }
  
    .goal-add-form button {
      align-self: flex-end;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #f9fafb;
      cursor: pointer;
    }
  
    /* User chooser overlay */
  
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(0,0,0,0.94));
      z-index: 50;
    }
  
    .overlay.hidden {
      display: none;
    }
  
    .overlay-panel {
      width: min(360px, 100% - 32px);
      background: rgba(15,23,42,0.98);
      border-radius: 18px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(148,163,184,0.55);
      box-shadow: var(--shadow-xl);
      text-align: left;
    }
  
    .overlay-panel h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
  
    .overlay-panel p {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--ink-soft);
    }
  
    .overlay-panel select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.98);
      color: var(--ink);
      padding: 6px 10px;
      margin-bottom: 10px;
      font-size: 13px;
    }
  
    .overlay-panel button {
      width: 100%;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #f9fafb;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }
  
    .overlay-panel small {
      display: block;
      margin-top: 6px;
      font-size: 11px;
      color: var(--ink-soft);
      text-align: center;
    }
  
    /* Task modal */
  
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
  
    .modal.hidden {
      display: none;
    }
  
    .modal-panel {
      width: min(420px, 100% - 32px);
      background: rgba(15,23,42,0.98);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: var(--shadow-xl);
      padding: 14px 14px 12px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
  
    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }
  
    .modal-close {
      border: none;
      background: transparent;
      color: var(--ink-soft);
      font-size: 18px;
      cursor: pointer;
    }
  
    .modal-body label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 6px;
      font-size: 11px;
      color: var(--ink-soft);
    }
  
    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.98);
      color: var(--ink);
      padding: 5px 7px;
      font-size: 12px;
    }
  
    .modal-body textarea {
      resize: vertical;
      min-height: 60px;
    }
  
    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
  
    .button-secondary,
    .button-danger,
    .button-primary {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
    }
  
    .button-secondary {
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(75,85,99,0.9);
      color: var(--ink-soft);
    }
  
    .button-danger {
      background: rgba(127,29,29,0.9);
      color: #fee2e2;
    }
  
    .button-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #f9fafb;
    }
  
    .toast {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.98);
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 11px;
      z-index: 60;
      display: none;
    }
  
    .toast.show {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
  
    .toast span {
      font-size: 12px;
    }
  
    /* TikTok-style action loader */
  
    .action-loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 80px;
      z-index: 80;
      pointer-events: none;
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }
  
    .action-loader.show {
      opacity: 1;
      transform: translateY(0);
    }
  
    .action-loader-inner {
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top left,
        rgba(15,23,42,0.98),
        rgba(15,23,42,0.96)
      );
      border: 1px solid rgba(148,163,184,0.65);
      box-shadow: 0 18px 45px rgba(0,0,0,0.75);
      backdrop-filter: blur(16px);
      font-size: 12px;
    }
  
    .loader-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(75,85,99,0.8);
      border-top-color: var(--accent-soft);
      animation: spin 0.7s linear infinite;
    }
  
    .action-loader-text-main {
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
  
    .action-loader-text-sub {
      display: block;
      font-size: 11px;
      color: var(--ink-soft);
      margin-top: 1px;
    }
  
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  
    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
  
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--ink-soft);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
  
    .theme-toggle select {
      border-radius: 999px;
      border: 1px solid var(--panel-border);
      background: var(--panel);
      color: var(--ink);
      padding: 3px 8px;
      font-size: 11px;
    }
  
    .goal-delete-btn {
      border: none;
      background: transparent;
      color: var(--accent-muted);
      font-size: 10px;
      cursor: pointer;
      padding: 0 2px;
      white-space: nowrap;
    }
  
    .goal-delete-btn:hover {
      color: var(--danger);
    }
  
    /* ================================
       Light Theme (Day) readability overrides
       ================================ */
  
    body:not([data-theme="dark"]) .panel-header {
      border-bottom: 1px solid #e5e7eb;
    }
  
    /* Calendar controls */
    body:not([data-theme="dark"]) .calendar-controls button,
    body:not([data-theme="dark"]) .calendar-controls select {
      background: #ffffff;
      color: #0f172a;
      border-color: #d1d5db;
    }
  
    body:not([data-theme="dark"]) .calendar-controls span.month-label {
      color: #0f172a;
    }
  
    /* Weekday row */
    body:not([data-theme="dark"]) .calendar-weekdays div {
      border-bottom: 1px solid #e5e7eb;
    }
  
    /* Calendar day cells + tasks */
    body:not([data-theme="dark"]) .day-cell {
      background: #ffffff;
      border-color: #e5e7eb;
    }
  
    body:not([data-theme="dark"]) .task-pill {
      background: #f9fafb;
      border-color: #e5e7eb;
    }
  
    /* Goals columns & cards */
    body:not([data-theme="dark"]) .goal-column {
      background: #ffffff;
      border-color: #e5e7eb;
    }
  
    body:not([data-theme="dark"]) .goal-card {
      background: #f9fafb;
      border-color: #e5e7eb;
    }
  
    /* Inputs in goals area */
    body:not([data-theme="dark"]) .goals-controls input[type="month"],
    body:not([data-theme="dark"]) .goals-controls select,
    body:not([data-theme="dark"]) .goals-controls input[type="number"],
    body:not([data-theme="dark"]) .goal-progress input[type="number"],
    body:not([data-theme="dark"]) .goal-row-note textarea,
    body:not([data-theme="dark"]) .goal-add-form input,
    body:not([data-theme="dark"]) .goal-add-form select {
      background: #ffffff;
      border-color: #d1d5db;
      color: #0f172a;
    }
  
    /* Overlay & modal surfaces */
    body:not([data-theme="dark"]) .overlay {
      background: rgba(15,23,42,0.3);
    }
  
    body:not([data-theme="dark"]) .overlay-panel,
    body:not([data-theme="dark"]) .modal-panel {
      background: #ffffff;
      border-color: #e5e7eb;
      color: #0f172a;
    }
  
    body:not([data-theme="dark"]) .overlay-panel select,
    body:not([data-theme="dark"]) .modal-body input,
    body:not([data-theme="dark"]) .modal-body select,
    body:not([data-theme="dark"]) .modal-body textarea {
      background: #ffffff;
      border-color: #d1d5db;
      color: #0f172a;
    }
  
    body:not([data-theme="dark"]) .modal {
      background: rgba(15,23,42,0.3);
    }
  
    /* Secondary buttons + toast */
    body:not([data-theme="dark"]) .button-secondary {
      background: #f9fafb;
      border-color: #d1d5db;
      color: #374151;
    }
  
    body:not([data-theme="dark"]) .toast {
      background: #111827;
      color: #f9fafb;
    }

    /* Drag & drop feedback */
        .task-pill.dragging {
        opacity: 0.45;
        }

        .day-cell.drop-target {
        outline: 2px dashed var(--accent-soft);
        outline-offset: 2px;
        }
  </style>
</head>
<body>
  <!-- User chooser -->
  <div id="user-overlay" class="overlay">
    <div class="overlay-panel">
      <h2>Who’s on the Wrap?</h2>
      <p>Select your name so we know who’s assigning and completing tasks.</p>
      <select id="user-select">
        <option value="">Loading team...</option>
      </select>
      <button id="user-select-confirm">Open Wrap Sheet</button>
      <small>This is internal for BER: Meighan, Kevin, Erica, Jenna &amp; Katie.</small>
    </div>
  </div>

  <!-- Task modal -->
  <div id="task-modal" class="modal hidden">
    <div class="modal-panel">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="task-modal-title">New Task</div>
          <div id="task-modal-date" style="font-size:11px;color:#9ca3af;"></div>
        </div>
        <button class="modal-close" id="task-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="task-id" />
        <label>
          Title
          <input id="task-title-input" placeholder="e.g., TTT: Market Reports video" />
        </label>
        <label>
          Notes
          <textarea id="task-notes-input" placeholder="Optional details…"></textarea>
        </label>
        <label>
          Assigned To
          <select id="task-assigned-to"></select>
        </label>
        <label>
          Status
          <select id="task-status-input">
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="done">Done</option>
          </select>
        </label>
      </div>
      <div class="modal-footer">
        <button class="button-secondary" id="task-modal-cancel">Cancel</button>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="button-danger" id="task-delete-btn" style="display:none;">Delete</button>
          <button class="button-primary" id="task-save-btn">Save Task</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

    <!-- TikTok-style action loader -->
    <div id="action-loader" class="action-loader">
        <div class="action-loader-inner">
          <div class="loader-spinner"></div>
          <div>
            <div class="action-loader-text-main" id="action-loader-main">Syncing…</div>
            <div class="action-loader-text-sub" id="action-loader-sub">
              Saving your change to the Wrap Sheet
            </div>
          </div>
        </div>
      </div>

  <div class="app-shell">
    <header class="app-header">
        <div class="branding">
          <div class="branding-mark">W</div>
          <div class="branding-text">
            <h1>Wrap Sheet</h1>
            <span>BER • DAILY TASKS • GOALS</span>
          </div>
        </div>
  
        <div class="header-controls">
          <div class="theme-toggle">
            <label for="theme-select">Theme</label>
            <select id="theme-select">
              <option value="light">Day</option>
              <option value="dark">Night</option>
            </select>
          </div>
  
          <div class="user-pill">
            <span id="current-user-label">Not signed in</span>
            <button id="switch-user-btn">Switch</button>
          </div>
        </div>
      </header>

    <main class="app-main">
      <!-- Calendar (full width) -->
      <section class="panel" id="calendar-panel">
        <div class="panel-header">
          <div class="panel-title">Daily Tasks</div>
          <div class="calendar-controls">
            <button id="month-prev">&larr;</button>
            <span class="month-label" id="month-label">Month YYYY</span>
            <button id="month-next">&rarr;</button>

            <select id="calendar-view-select">
              <option value="month">Month</option>
              <option value="week">Full Week</option>
              <option value="workweek">Work Week</option>
            </select>

            <select id="calendar-owner-select">
              <option value="">My Tasks</option>
            </select>

            <div class="calendar-legend">
              <span><span class="legend-dot legend-pending"></span>Pending</span>
              <span><span class="legend-dot legend-inprogress"></span>In Progress</span>
              <span><span class="legend-dot legend-done"></span>Done</span>
            </div>
          </div>
        </div>
        <div class="calendar-grid">
          <div class="calendar-weekdays" id="calendar-weekdays"></div>
          <div class="calendar-days" id="calendar-days"></div>
        </div>
        <div class="calendar-metrics">
          <canvas id="status-pie" width="150" height="150"></canvas>
        </div>
      </section>

      <!-- Goals (now at the bottom) -->
      <section class="panel" id="goals-panel">
        <div class="panel-header">
          <div class="panel-title">Goals & Focus</div>
          <div class="goals-tabs">
            <button class="goals-tab active" data-tab="monthly">Monthly Strategies</button>
            <button class="goals-tab" data-tab="annual">Annual Goals</button>
          </div>
        </div>

        <!-- Monthly Goals -->
        <div id="monthly-goals-panel">
          <div class="goals-controls">
            <label>
              Month
              <input type="month" id="monthly-month-input" />
            </label>
            <label>
              Owner
              <select id="monthly-owner-filter">
                <option value="all">Everyone</option>
              </select>
            </label>
          </div>
          <div class="goals-grid" id="monthly-goals-grid"></div>
        </div>

        <!-- Annual Goals -->
        <div id="annual-goals-panel" style="display:none;">
          <div class="goals-controls">
            <label>
              Year
              <select id="annual-year-input"></select>
            </label>
            <label>
              Owner
              <select id="annual-owner-filter">
                <option value="all">Everyone</option>
              </select>
            </label>
          </div>
          <div class="goals-grid" id="annual-goals-grid"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://wrapsheet.bonitaspringsrealtors.workers.dev/api";

    const MONTHLY_CATEGORIES = [
      "Compliance/Audit",
      "Marketing",
      "Products & Tools",
      "Personal Focus",
      "Moving the Needle",
      "Team Work"
    ];

    const ANNUAL_CATEGORIES = [
      "Compliance/Audit",
      "Marketing",
      "Products & Tools",
      "Personal Focus",
      "Moving the Needle",
      "Team Work"
    ];

    const state = {
      users: [],
      currentUser: null,
      currentMonthDate: new Date(),
      dailyTasks: [],
      monthlyGoals: [],
      annualGoals: [],
      monthlyOwnerFilter: "all",
      annualOwnerFilter: "all",
      annualYear: new Date().getFullYear(),
      calendarView: "month",
      calendarOwnerId: null,
      theme: "light"
    };

    const LOADER_MESSAGES = [
      {
        main: "Syncing…",
        sub: "Saving your change to the Wrap Sheet"
      },
      {
        main: "Updating tasks…",
        sub: "Pushing your edits to HQ"
      },
      {
        main: "Locking it in…",
        sub: "Your goals are being updated"
      },
      {
        main: "Polishing your wrap…",
        sub: "Making everything look just right"
      },
      {
        main: "Checking it twice…",
        sub: "Confirming those changes with the cloud"
      }
    ];

    function pickLoaderMessage() {
      return LOADER_MESSAGES[
        Math.floor(Math.random() * LOADER_MESSAGES.length)
      ];
    }

    function showActionLoader(customMessage) {
      const loader = document.getElementById("action-loader");
      if (!loader) return;

      const mainEl = document.getElementById("action-loader-main");
      const subEl = document.getElementById("action-loader-sub");

      const msg = customMessage || pickLoaderMessage();

      if (typeof msg === "string") {
        mainEl.textContent = msg;
        subEl.textContent = "One sec while we save that…";
      } else {
        mainEl.textContent = msg.main || "Syncing…";
        subEl.textContent = msg.sub || "Saving your change…";
      }

      loader.classList.add("show");
    }

    function hideActionLoader() {
      const loader = document.getElementById("action-loader");
      if (!loader) return;
      loader.classList.remove("show");
    }


    // ===== UTILITIES =====
    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function monthKeyFromDate(d) {
      return d.getFullYear() + "-" + pad2(d.getMonth() + 1);
    }

    function dateKey(y, mIndexZeroBased, day) {
      return y + "-" + pad2(mIndexZeroBased + 1) + "-" + pad2(day);
    }

    function addDays(date, days) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      d.setDate(d.getDate() + days);
      return d;
    }

    function getWeekStart(date, weekStartsOnMonday = false) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = d.getDay(); // 0–6 (Sun–Sat)
      let diff;
      if (weekStartsOnMonday) {
        diff = day === 0 ? -6 : 1 - day;
      } else {
        diff = -day;
      }
      d.setDate(d.getDate() + diff);
      return d;
    }

    function getVisibleDateRange() {
      const base = state.currentMonthDate;
      const year = base.getFullYear();
      const month = base.getMonth();

      if (state.calendarView === "month") {
        const first = dateKey(year, month, 1);
        const lastDay = new Date(year, month + 1, 0).getDate();
        const last = dateKey(year, month, lastDay);
        return [first, last];
      }

      const isWorkweek = state.calendarView === "workweek";
      const weekStart = getWeekStart(base, isWorkweek);
      const daysCount = isWorkweek ? 4 : 6; // inclusive end
      const startKey = dateKey(
        weekStart.getFullYear(),
        weekStart.getMonth(),
        weekStart.getDate()
      );
      const weekEnd = addDays(weekStart, daysCount);
      const endKey = dateKey(
        weekEnd.getFullYear(),
        weekEnd.getMonth(),
        weekEnd.getDate()
      );
      return [startKey, endKey];
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      toast.textContent = "";
      const span = document.createElement("span");
      span.textContent = message;
      toast.appendChild(span);
      toast.style.borderColor = isError ? "#f97373" : "rgba(148,163,184,0.7)";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2800);
    }

    async function apiGet(path) {
      const res = await fetch(API_BASE + path, {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error("GET " + path + " failed");
      return res.json();
    }

    async function apiSend(path, method, body) {
      showActionLoader(); // TikTok-style popup

      // random delay between 500ms and 2000ms
      const delayMs = 500 + Math.random() * 1500;
      const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));

      try {
        const fetchPromise = fetch(API_BASE + path, {
          method,
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(body)
        });

        // Wait for BOTH: the network AND the fake delay
        const res = await Promise.all([fetchPromise, delayPromise]).then(
          ([res]) => res
        );

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(method + " " + path + " failed: " + text);
        }

        const data = await res.json();
        return data;
      } finally {
        hideActionLoader();
      }
    }

    function applyTheme(theme) {
      const safeTheme = theme === "dark" ? "dark" : "light";
      state.theme = safeTheme;
      document.body.dataset.theme = safeTheme;

      const select = document.getElementById("theme-select");
      if (select && select.value !== safeTheme) {
        select.value = safeTheme;
      }

      try {
        localStorage.setItem("wrapsheet-theme", safeTheme);
      } catch {
        // ignore storage errors
      }
    }

    function initTheme() {
      let stored = null;
      try {
        stored = localStorage.getItem("wrapsheet-theme");
      } catch {
        stored = null;
      }
      const initial = stored === "dark" ? "dark" : "light";
      applyTheme(initial);
    }


    // ===== INITIAL LOAD =====
    document.addEventListener("DOMContentLoaded", async () => {
      attachEventHandlers();

      initTheme();

      try {
        await loadUsers();
      } catch (err) {
        console.error(err);
        showToast("Error loading users", true);
      }
      restoreUserFromStorage();
      if (state.currentUser) {
        document.getElementById("user-overlay").classList.add("hidden");
        await refreshAllData();
      }
    });

    async function loadUsers() {
      const users = await apiGet("/users");
      state.users = users;
      populateUserSelects();
    }

    function populateUserSelects() {
      const userSelect = document.getElementById("user-select");
      userSelect.innerHTML = '<option value="">Select your name…</option>';
      state.users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        userSelect.appendChild(opt);
      });

      const monthlyOwnerFilter = document.getElementById("monthly-owner-filter");
      const annualOwnerFilter = document.getElementById("annual-owner-filter");
      [monthlyOwnerFilter, annualOwnerFilter].forEach(sel => {
        while (sel.options.length > 1) sel.remove(1); // keep "Everyone"
        state.users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = String(u.id);
          opt.textContent = u.name;
          sel.appendChild(opt);
        });
      });

      const taskAssignedTo = document.getElementById("task-assigned-to");
      taskAssignedTo.innerHTML = "";
      state.users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.name;
        taskAssignedTo.appendChild(opt);
      });
    }

    function populateCalendarOwnerSelect() {
      const sel = document.getElementById("calendar-owner-select");
      if (!sel) return;
      sel.innerHTML = "";
      if (!state.currentUser) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Select user…";
        sel.appendChild(opt);
        sel.disabled = true;
        return;
      }
      sel.disabled = false;

      const mine = document.createElement("option");
      mine.value = "me";
      mine.textContent = "My Tasks";
      sel.appendChild(mine);

      const all = document.createElement("option");
      all.value = "all";
      all.textContent = "All Team";
      sel.appendChild(all);

      state.users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = String(u.id);
        opt.textContent = u.name;
        sel.appendChild(opt);
      });

      sel.value = "me";
    }

    function restoreUserFromStorage() {
      const stored = localStorage.getItem("wrapsheet-user");
      if (!stored) return;
      const parsed = JSON.parse(stored);
      const found = state.users.find(u => u.id === parsed.id);
      if (found) setCurrentUser(found);
    }

    function setCurrentUser(user) {
      state.currentUser = user;
      document.getElementById("current-user-label").textContent =
        user ? user.name + " · " + user.email : "Not signed in";
      if (user) {
        localStorage.setItem("wrapsheet-user", JSON.stringify({ id: user.id }));
        document.getElementById("monthly-owner-filter").value = "all";
        document.getElementById("annual-owner-filter").value = "all";
        state.calendarOwnerId = user.id;
        populateCalendarOwnerSelect();
      }
    }

    // ===== EVENT HANDLERS =====
    function attachEventHandlers() {
        const themeSelect = document.getElementById("theme-select");
      if (themeSelect) {
        themeSelect.addEventListener("change", () => {
          applyTheme(themeSelect.value);
        });
      }
      // User overlay
      document.getElementById("user-select-confirm").addEventListener("click", async () => {
        const id = parseInt(document.getElementById("user-select").value, 10);
        if (!id) {
          showToast("Please pick your name");
          return;
        }
        const user = state.users.find(u => u.id === id);
        if (!user) return;
        setCurrentUser(user);
        document.getElementById("user-overlay").classList.add("hidden");
        await refreshAllData();
      });

      document.getElementById("switch-user-btn").addEventListener("click", () => {
        document.getElementById("user-overlay").classList.remove("hidden");
      });

      // Calendar view switcher
      const calendarViewSelect = document.getElementById("calendar-view-select");
      calendarViewSelect.addEventListener("change", () => {
        state.calendarView = calendarViewSelect.value;
        updateMonthLabel();
        renderCalendar();
      });

      // Calendar owner (whose calendar you are viewing)
      const calendarOwnerSelect = document.getElementById("calendar-owner-select");
      calendarOwnerSelect.addEventListener("change", async () => {
        const val = calendarOwnerSelect.value;
        if (val === "me") {
          state.calendarOwnerId = state.currentUser ? state.currentUser.id : null;
        } else if (val === "all") {
          state.calendarOwnerId = null;
        } else {
          state.calendarOwnerId = parseInt(val, 10);
        }
        await loadDailyTasks();
      });

      // Navigation: prev/next
      document.getElementById("month-prev").addEventListener("click", async () => {
        const d = state.currentMonthDate;
        if (state.calendarView === "month") {
          state.currentMonthDate = new Date(d.getFullYear(), d.getMonth() - 1, 1);
        } else {
          state.currentMonthDate = addDays(d, -7);
        }
        await refreshCalendarAndMonthlyGoals();
      });

      document.getElementById("month-next").addEventListener("click", async () => {
        const d = state.currentMonthDate;
        if (state.calendarView === "month") {
          state.currentMonthDate = new Date(d.getFullYear(), d.getMonth() + 1, 1);
        } else {
          state.currentMonthDate = addDays(d, 7);
        }
        await refreshCalendarAndMonthlyGoals();
      });

      // Goals tabs
      document.querySelectorAll(".goals-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll(".goals-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          if (tab === "monthly") {
            document.getElementById("monthly-goals-panel").style.display = "";
            document.getElementById("annual-goals-panel").style.display = "none";
          } else {
            document.getElementById("monthly-goals-panel").style.display = "none";
            document.getElementById("annual-goals-panel").style.display = "";
          }
        });
      });

      // Monthly goals: month input
      const monthlyMonthInput = document.getElementById("monthly-month-input");
      monthlyMonthInput.addEventListener("change", async () => {
        if (!monthlyMonthInput.value) return;
        const [year, month] = monthlyMonthInput.value.split("-").map(Number);
        state.currentMonthDate = new Date(year, month - 1, 1);
        await refreshCalendarAndMonthlyGoals();
      });

      // Owner filters (goals)
      document.getElementById("monthly-owner-filter").addEventListener("change", () => {
        state.monthlyOwnerFilter = document.getElementById("monthly-owner-filter").value;
        renderMonthlyGoals();
      });

      document.getElementById("annual-owner-filter").addEventListener("change", () => {
        state.annualOwnerFilter = document.getElementById("annual-owner-filter").value;
        renderAnnualGoals();
      });

      // Annual year input
      const annualYearInput = document.getElementById("annual-year-input");
      const thisYear = new Date().getFullYear();
      for (let y = thisYear - 1; y <= thisYear + 4; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === thisYear) opt.selected = true;
        annualYearInput.appendChild(opt);
      }
      annualYearInput.addEventListener("change", async () => {
        state.annualYear = parseInt(annualYearInput.value, 10);
        await loadAnnualGoals();
      });

      // Task modal controls
      document.getElementById("task-modal-close").addEventListener("click", closeTaskModal);
      document.getElementById("task-modal-cancel").addEventListener("click", closeTaskModal);
      document.getElementById("task-save-btn").addEventListener("click", onTaskSave);
      document.getElementById("task-delete-btn").addEventListener("click", onTaskDelete);
    }

    // ===== DATA REFRESH =====
    async function refreshAllData() {
      await refreshCalendarAndMonthlyGoals();
      await loadAnnualGoals();
    }

    async function refreshCalendarAndMonthlyGoals() {
      updateMonthLabel();
      setMonthInputsFromState();
      await Promise.all([loadDailyTasks(), loadMonthlyGoals()]);
    }

    function updateMonthLabel() {
      const labelEl = document.getElementById("month-label");
      const d = state.currentMonthDate;
      if (state.calendarView === "month") {
        const monthName = d.toLocaleString("default", { month: "long" });
        labelEl.textContent = monthName + " " + d.getFullYear();
      } else {
        const isWorkweek = state.calendarView === "workweek";
        const weekStart = getWeekStart(d, isWorkweek);
        const weekEnd = addDays(weekStart, isWorkweek ? 4 : 6);
        const startLabel = weekStart.toLocaleString("default", {
          month: "short",
          day: "numeric"
        });
        const endLabel = weekEnd.toLocaleString("default", {
          month: "short",
          day: "numeric",
          year: "numeric"
        });
        labelEl.textContent = `${startLabel} – ${endLabel}`;
      }
    }

    function setMonthInputsFromState() {
      const d = state.currentMonthDate;
      const monthVal = d.getFullYear() + "-" + pad2(d.getMonth() + 1);
      document.getElementById("monthly-month-input").value = monthVal;
    }

    async function loadDailyTasks() {
      const mk = monthKeyFromDate(state.currentMonthDate);
      try {
        let path = "/daily-tasks?month=" + encodeURIComponent(mk);
        const ownerId = state.calendarOwnerId || (state.currentUser && state.currentUser.id);
        if (ownerId) {
          path += "&assignedToId=" + encodeURIComponent(ownerId);
        }
        const tasks = await apiGet(path);
        state.dailyTasks = tasks;
        renderCalendar();
      } catch (err) {
        console.error(err);
        showToast("Error loading daily tasks", true);
      }
    }

    async function loadMonthlyGoals() {
      const mk = monthKeyFromDate(state.currentMonthDate);
      try {
        const goals = await apiGet("/monthly-goals?month=" + encodeURIComponent(mk));
        state.monthlyGoals = goals;
        renderMonthlyGoals();
      } catch (err) {
        console.error(err);
        showToast("Error loading monthly goals", true);
      }
    }

    async function loadAnnualGoals() {
      try {
        const goals = await apiGet("/annual-goals?year=" + encodeURIComponent(state.annualYear));
        state.annualGoals = goals;
        renderAnnualGoals();
      } catch (err) {
        console.error(err);
        showToast("Error loading annual goals", true);
      }
    }

    // ===== CALENDAR RENDERING =====
    function buildDayCell(key, displayDayNumber, todayKey, tasksByDate) {
      const cell = document.createElement("div");
      cell.className = "day-cell";
      if (key === todayKey) cell.classList.add("is-today");

      const header = document.createElement("div");
      header.className = "day-header";

      const num = document.createElement("div");
      num.className = "day-number";
      num.textContent = displayDayNumber;
      header.appendChild(num);

      const addBtn = document.createElement("button");
      addBtn.className = "add-task-btn";
      addBtn.textContent = "+";
      addBtn.title = "Add task";
      addBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openTaskModalForDate(key);
      });
      header.appendChild(addBtn);

      cell.appendChild(header);

      const list = document.createElement("div");
      list.className = "tasks-list";
      const tasks = tasksByDate[key] || [];
      tasks.forEach(task => {
        const pill = document.createElement("div");
        pill.className = "task-pill";

        const dot = document.createElement("div");
        dot.className = "task-status-dot";
        dot.classList.add("task-status-" + (task.status || "pending"));
        pill.appendChild(dot);

        const title = document.createElement("div");
        title.className = "task-title";
        title.textContent = task.title;
        pill.appendChild(title);

        const assignee = document.createElement("div");
        assignee.className = "task-assignee";
        const assignedUser = state.users.find(u => u.id === task.assigned_to_id);
        assignee.textContent = assignedUser ? assignedUser.name : "";
        pill.appendChild(assignee);

        pill.addEventListener("click", (e) => {
          e.stopPropagation();
          openTaskModalForExistingTask(task);
        });

        list.appendChild(pill);
      });

      cell.appendChild(list);
      return cell;
    }

    function renderCalendar() {
      const weekdaysEl = document.getElementById("calendar-weekdays");
      const container = document.getElementById("calendar-days");
      weekdaysEl.innerHTML = "";
      container.innerHTML = "";

      const d = state.currentMonthDate;
      const year = d.getFullYear();
      const monthIndex = d.getMonth();
      const today = new Date();
      const todayKey = dateKey(today.getFullYear(), today.getMonth(), today.getDate());

      const tasksByDate = {};
      state.dailyTasks.forEach(t => {
        const key = t.task_date;
        if (!tasksByDate[key]) tasksByDate[key] = [];
        tasksByDate[key].push(t);
      });

      if (state.calendarView === "month") {
        const weekdayLabels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        weekdayLabels.forEach(label => {
          const div = document.createElement("div");
          div.textContent = label;
          weekdaysEl.appendChild(div);
        });
        container.style.gridTemplateColumns = "repeat(7, minmax(0, 1fr))";

        const firstDay = new Date(year, monthIndex, 1);
        const firstWeekday = firstDay.getDay();
        const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

        for (let i = 0; i < firstWeekday; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "day-cell day-cell-empty";
          container.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const key = dateKey(year, monthIndex, day);
          const cell = buildDayCell(key, day, todayKey, tasksByDate);
          container.appendChild(cell);
        }
      } else {
        const isWorkweek = state.calendarView === "workweek";
        const weekStart = getWeekStart(d, isWorkweek);
        const labels = isWorkweek
          ? ["Mon","Tue","Wed","Thu","Fri"]
          : ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
        const daysCount = isWorkweek ? 5 : 7;

        labels.forEach(label => {
          const div = document.createElement("div");
          div.textContent = label;
          weekdaysEl.appendChild(div);
        });
        container.style.gridTemplateColumns = `repeat(${daysCount}, minmax(0, 1fr))`;

        for (let i = 0; i < daysCount; i++) {
          const dateObj = addDays(weekStart, i);
          const key = dateKey(
            dateObj.getFullYear(),
            dateObj.getMonth(),
            dateObj.getDate()
          );
          const dayNumber = dateObj.getDate();
          const cell = buildDayCell(key, dayNumber, todayKey, tasksByDate);
          container.appendChild(cell);
        }
      }

      updateStatusChart();
    }

    function updateStatusChart() {
      const canvas = document.getElementById("status-pie");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      ctx.clearRect(0, 0, width, height);

      const [startKey, endKey] = getVisibleDateRange();

      let pending = 0;
      let inProgress = 0;
      let done = 0;

      state.dailyTasks.forEach(t => {
        const date = t.task_date;
        if (!date || date < startKey || date > endKey) return;
        const status = t.status || "pending";
        if (status === "done") done++;
        else if (status === "in_progress") inProgress++;
        else pending++;
      });

      const total = pending + inProgress + done;
      const cx = width / 2;
      const cy = height / 2;
      const radius = Math.min(width, height) / 2 - 4;

      if (!total) {
        ctx.fillStyle = "#6b7280";
        ctx.font = "12px system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("No tasks", cx, cy);
        return;
      }

      const segments = [
        { value: pending,   color: "rgba(248,250,252,0.3)" },
        { value: inProgress, color: "#12d0c9" },
        { value: done,      color: "#22c55e" }
      ];

      let startAngle = -Math.PI / 2;
      segments.forEach(seg => {
        if (!seg.value) return;
        const sliceAngle = (seg.value / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius, startAngle, startAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = seg.color;
        ctx.fill();
        startAngle += sliceAngle;
      });

      // Inner circle for donut effect
      ctx.beginPath();
      ctx.arc(cx, cy, radius * 0.5, 0, Math.PI * 2);
      ctx.closePath();
      ctx.fillStyle = "#020617";
      ctx.fill();
    }

    // ===== TASK MODAL & CRUD =====
    function openTaskModalForDate(dateStr) {
      const modal = document.getElementById("task-modal");
      document.getElementById("task-id").value = "";
      document.getElementById("task-title-input").value = "";
      document.getElementById("task-notes-input").value = "";
      document.getElementById("task-status-input").value = "pending";
      document.getElementById("task-modal-title").textContent = "New Task";
      document.getElementById("task-modal-date").textContent = dateStr;
      document.getElementById("task-delete-btn").style.display = "none";

      const taskAssignedTo = document.getElementById("task-assigned-to");
      const defaultAssigneeId =
        state.calendarOwnerId || (state.currentUser && state.currentUser.id);
      if (defaultAssigneeId) {
        taskAssignedTo.value = String(defaultAssigneeId);
      }

      modal.dataset.date = dateStr;
      modal.classList.remove("hidden");
    }

    function openTaskModalForExistingTask(task) {
      const modal = document.getElementById("task-modal");
      document.getElementById("task-id").value = task.id;
      document.getElementById("task-title-input").value = task.title || "";
      document.getElementById("task-notes-input").value = task.notes || "";
      document.getElementById("task-status-input").value = task.status || "pending";
      document.getElementById("task-modal-title").textContent = "Edit Task";
      document.getElementById("task-modal-date").textContent = task.task_date || "";
      const taskAssignedTo = document.getElementById("task-assigned-to");
      taskAssignedTo.value = String(task.assigned_to_id);
      document.getElementById("task-delete-btn").style.display = "inline-flex";
      modal.dataset.date = task.task_date || "";
      modal.classList.remove("hidden");
    }

    function closeTaskModal() {
      document.getElementById("task-modal").classList.add("hidden");
    }

    async function onTaskSave() {
      if (!state.currentUser) {
        showToast("Pick your user first", true);
        return;
      }
      const id = document.getElementById("task-id").value;
      const title = document.getElementById("task-title-input").value.trim();
      const notes = document.getElementById("task-notes-input").value.trim();
      const status = document.getElementById("task-status-input").value;
      const assignedToId = parseInt(document.getElementById("task-assigned-to").value, 10);
      const dateStr = document.getElementById("task-modal").dataset.date;

      if (!title) {
        showToast("Task title is required", true);
        return;
      }

      try {
        if (id) {
          await apiSend("/daily-tasks/" + id, "PATCH", {
            title,
            notes,
            status,
            assigned_to_id: assignedToId
          });
        } else {
          await apiSend("/daily-tasks", "POST", {
            title,
            notes,
            task_date: dateStr,
            created_by_id: state.currentUser.id,
            assigned_to_id: assignedToId,
            assigned_by_id: state.currentUser.id
          });
        }
        closeTaskModal();
        await loadDailyTasks();
        showToast("Task saved");
      } catch (err) {
        console.error(err);
        showToast("Error saving task", true);
      }
    }

    async function onTaskDelete() {
      const id = document.getElementById("task-id").value;
      if (!id) return;
      if (!confirm("Delete this task?")) return;

      // random delay between 500ms and 2000ms
      const delayMs = 500 + Math.random() * 1500;
      const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));

      try {
        showActionLoader({
          main: "Deleting…",
          sub: "Cleaning up this task"
        });

        const fetchPromise = fetch(API_BASE + "/daily-tasks/" + id, {
          method: "DELETE"
        });

        const res = await Promise.all([fetchPromise, delayPromise]).then(
          ([res]) => res
        );

        if (!res.ok) throw new Error("Delete failed");

        closeTaskModal();
        await loadDailyTasks();
        showToast("Task deleted");
      } catch (err) {
        console.error(err);
        showToast("Error deleting task (check Worker)", true);
      } finally {
        hideActionLoader();
      }
    }



    // ===== GOALS RENDERING & CRUD =====
    function renderMonthlyGoals() {
      const grid = document.getElementById("monthly-goals-grid");
      grid.innerHTML = "";

      const ownerFilter = state.monthlyOwnerFilter;
      const goals = state.monthlyGoals.filter(g => {
        if (ownerFilter === "all") return true;
        return String(g.owner_id) === ownerFilter;
      });

      const goalsByCategory = {};
      MONTHLY_CATEGORIES.forEach(cat => goalsByCategory[cat] = []);
      goals.forEach(g => {
        if (!goalsByCategory[g.category]) goalsByCategory[g.category] = [];
        goalsByCategory[g.category].push(g);
      });

      MONTHLY_CATEGORIES.forEach(category => {
        const col = document.createElement("div");
        col.className = "goal-column";

        const title = document.createElement("div");
        title.className = "goal-column-title";
        title.textContent = category;
        col.appendChild(title);

        const list = document.createElement("div");
        const items = goalsByCategory[category] || [];
        items.forEach(goal => {
          const card = document.createElement("div");
          card.className = "goal-card";
          if (goal.is_complete) card.classList.add("completed");

          const topRow = document.createElement("div");
          topRow.className = "goal-row-top";

          const titleInput = document.createElement("input");
          titleInput.className = "goal-title-input";
          titleInput.value = goal.title || "";
          titleInput.placeholder = "Goal title…";
          titleInput.addEventListener("change", () => {
            updateMonthlyGoal(goal.id, { title: titleInput.value.trim() });
          });
          topRow.appendChild(titleInput);

          const ownerTag = document.createElement("div");
          ownerTag.className = "goal-owner-tag";
          const owner = state.users.find(u => u.id === goal.owner_id);
          ownerTag.textContent = owner ? owner.name : "";
          topRow.appendChild(ownerTag);

          card.appendChild(topRow);

          const midRow = document.createElement("div");
          midRow.className = "goal-row-middle";

          const progressWrap = document.createElement("div");
          progressWrap.className = "goal-progress";
          const progressLabel = document.createElement("span");
          progressLabel.textContent = "Progress";
          const progressInput = document.createElement("input");
          progressInput.type = "number";
          progressInput.min = "0";
          progressInput.max = "100";
          progressInput.value = goal.progress_percent ?? 0;
          progressInput.addEventListener("change", () => {
            let val = parseFloat(progressInput.value);
            if (isNaN(val)) val = 0;
            if (val < 0) val = 0;
            if (val > 100) val = 100;
            progressInput.value = val;
            updateMonthlyGoal(goal.id, { progress_percent: val });
          });
          const percentSymbol = document.createElement("span");
          percentSymbol.textContent = "%";
          progressWrap.appendChild(progressLabel);
          progressWrap.appendChild(progressInput);
          progressWrap.appendChild(percentSymbol);

          midRow.appendChild(progressWrap);

          const doneLabel = document.createElement("label");
          doneLabel.className = "goal-done-toggle";
          const doneCheckbox = document.createElement("input");
          doneCheckbox.type = "checkbox";
          doneCheckbox.checked = !!goal.is_complete;
          doneCheckbox.addEventListener("change", () => {
            updateMonthlyGoal(goal.id, { is_complete: doneCheckbox.checked ? 1 : 0 });
            if (doneCheckbox.checked) {
              card.classList.add("completed");
            } else {
              card.classList.remove("completed");
            }
          });
          const doneText = document.createElement("span");
          doneText.textContent = "Done";
          doneLabel.appendChild(doneCheckbox);
          doneLabel.appendChild(doneText);
          midRow.appendChild(doneLabel);

          card.appendChild(midRow);

          const noteRow = document.createElement("div");
          noteRow.className = "goal-row-note";
          const noteArea = document.createElement("textarea");
          noteArea.value = goal.progress_note || goal.description || "";
          noteArea.placeholder = "Description / notes…";
          noteArea.addEventListener("change", () => {
            updateMonthlyGoal(goal.id, { progress_note: noteArea.value.trim() });
          });
          noteRow.appendChild(noteArea);
          card.appendChild(noteRow);

          list.appendChild(card);
        });

        col.appendChild(list);

        // Add form for new goals in this category
        const addForm = document.createElement("div");
        addForm.className = "goal-add-form";

        const addTitleInput = document.createElement("input");
        addTitleInput.type = "text";
        addTitleInput.placeholder = "Add new goal…";
        addForm.appendChild(addTitleInput);

        const addOwnerSelect = document.createElement("select");
        state.users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          addOwnerSelect.appendChild(opt);
        });
        if (state.currentUser) {
          addOwnerSelect.value = String(state.currentUser.id);
        }
        addForm.appendChild(addOwnerSelect);

        const addButton = document.createElement("button");
        addButton.textContent = "Add Goal";
        addButton.addEventListener("click", async () => {
          const title = addTitleInput.value.trim();
          const ownerId = parseInt(addOwnerSelect.value, 10);
          if (!title) {
            showToast("Enter a goal title", true);
            return;
          }
          if (!ownerId) {
            showToast("Pick an owner", true);
            return;
          }
          try {
            await createMonthlyGoal({
              owner_id: ownerId,
              month_key: monthKeyFromDate(state.currentMonthDate),
              category,
              title,
              description: ""
            });
            addTitleInput.value = "";
            showToast("Monthly goal added");
          } catch (err) {
            console.error(err);
            showToast("Error adding monthly goal", true);
          }
        });
        addForm.appendChild(addButton);

        col.appendChild(addForm);

        grid.appendChild(col);
      });
    }

    async function updateMonthlyGoal(id, patch) {
      try {
        await apiSend("/monthly-goals/" + id, "PATCH", patch);
      } catch (err) {
        console.error(err);
        showToast("Error updating monthly goal", true);
      }
    }

    async function createMonthlyGoal(payload) {
      try {
        await apiSend("/monthly-goals", "POST", payload);
        await loadMonthlyGoals();
      } catch (err) {
        console.error(err);
        throw err;
      }
    }

    function renderAnnualGoals() {
      const grid = document.getElementById("annual-goals-grid");
      grid.innerHTML = "";

      const ownerFilter = state.annualOwnerFilter;
      const goals = state.annualGoals.filter(g => {
        if (ownerFilter === "all") return true;
        return String(g.owner_id) === ownerFilter;
      });

      const goalsByCategory = {};
      ANNUAL_CATEGORIES.forEach(cat => goalsByCategory[cat] = []);
      goals.forEach(g => {
        if (!goalsByCategory[g.category]) goalsByCategory[g.category] = [];
        goalsByCategory[g.category].push(g);
      });

      ANNUAL_CATEGORIES.forEach(category => {
        const col = document.createElement("div");
        col.className = "goal-column";

        const title = document.createElement("div");
        title.className = "goal-column-title";
        title.textContent = category;
        col.appendChild(title);

        const list = document.createElement("div");
        const items = goalsByCategory[category] || [];

        items.forEach(goal => {
          const card = document.createElement("div");
          card.className = "goal-card";
          if (goal.is_complete) card.classList.add("completed");

          const topRow = document.createElement("div");
        topRow.className = "goal-row-top";

        const titleInput = document.createElement("input");
        titleInput.className = "goal-title-input";
        titleInput.value = goal.title || "";
        titleInput.placeholder = "Goal title…";
        titleInput.addEventListener("change", () => {
          updateAnnualGoal(goal.id, { title: titleInput.value.trim() });
        });
        topRow.appendChild(titleInput);

        const ownerTag = document.createElement("div");
        ownerTag.className = "goal-owner-tag";
        const owner = state.users.find(u => u.id === goal.owner_id);
        ownerTag.textContent = owner ? owner.name : "";
        topRow.appendChild(ownerTag);

        // NEW: Remove button
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.className = "goal-delete-btn";
        deleteBtn.textContent = "Remove";
        deleteBtn.addEventListener("click", async (e) => {
          e.stopPropagation();
          await deleteAnnualGoal(goal.id);
        });
        topRow.appendChild(deleteBtn);

        card.appendChild(topRow);

          const midRow = document.createElement("div");
          midRow.className = "goal-row-middle";

          const progressWrap = document.createElement("div");
          progressWrap.className = "goal-progress";
          const progressLabel = document.createElement("span");
          progressLabel.textContent = "Progress";
          const progressInput = document.createElement("input");
          progressInput.type = "number";
          progressInput.min = "0";
          progressInput.max = "100";
          progressInput.value = goal.progress_percent ?? 0;
          progressInput.addEventListener("change", () => {
            let val = parseFloat(progressInput.value);
            if (isNaN(val)) val = 0;
            if (val < 0) val = 0;
            if (val > 100) val = 100;
            progressInput.value = val;
            updateAnnualGoal(goal.id, { progress_percent: val });
          });
          const percentSymbol = document.createElement("span");
          percentSymbol.textContent = "%";
          progressWrap.appendChild(progressLabel);
          progressWrap.appendChild(progressInput);
          progressWrap.appendChild(percentSymbol);

          midRow.appendChild(progressWrap);

          const doneLabel = document.createElement("label");
          doneLabel.className = "goal-done-toggle";
          const doneCheckbox = document.createElement("input");
          doneCheckbox.type = "checkbox";
          doneCheckbox.checked = !!goal.is_complete;
          doneCheckbox.addEventListener("change", () => {
            updateAnnualGoal(goal.id, { is_complete: doneCheckbox.checked ? 1 : 0 });
            if (doneCheckbox.checked) {
              card.classList.add("completed");
            } else {
              card.classList.remove("completed");
            }
          });
          const doneText = document.createElement("span");
          doneText.textContent = "Done";
          doneLabel.appendChild(doneCheckbox);
          doneLabel.appendChild(doneText);
          midRow.appendChild(doneLabel);

          card.appendChild(midRow);

          const noteRow = document.createElement("div");
          noteRow.className = "goal-row-note";
          const noteArea = document.createElement("textarea");
          noteArea.value = goal.progress_note || goal.description || "";
          noteArea.placeholder = "Description / notes…";
          noteArea.addEventListener("change", () => {
            updateAnnualGoal(goal.id, { progress_note: noteArea.value.trim() });
          });
          noteRow.appendChild(noteArea);
          card.appendChild(noteRow);

          list.appendChild(card);
        });

        col.appendChild(list);

        const addForm = document.createElement("div");
        addForm.className = "goal-add-form";

        const addTitleInput = document.createElement("input");
        addTitleInput.type = "text";
        addTitleInput.placeholder = "Add new annual goal…";
        addForm.appendChild(addTitleInput);

        const addOwnerSelect = document.createElement("select");
        state.users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          addOwnerSelect.appendChild(opt);
        });
        if (state.currentUser) {
          addOwnerSelect.value = String(state.currentUser.id);
        }
        addForm.appendChild(addOwnerSelect);

        const addButton = document.createElement("button");
        addButton.textContent = "Add Goal";
        addButton.addEventListener("click", async () => {
          const title = addTitleInput.value.trim();
          const ownerId = parseInt(addOwnerSelect.value, 10);
          if (!title) {
            showToast("Enter a goal title", true);
            return;
          }
          if (!ownerId) {
            showToast("Pick an owner", true);
            return;
          }
          try {
            await createAnnualGoal({
              owner_id: ownerId,
              year: state.annualYear,
              category,
              title,
              description: ""
            });
            addTitleInput.value = "";
            showToast("Annual goal added");
          } catch (err) {
            console.error(err);
            showToast("Error adding annual goal", true);
          }
        });
        addForm.appendChild(addButton);

        col.appendChild(addForm);

        grid.appendChild(col);
      });
    }

    async function deleteAnnualGoal(id) {
      if (!id) return;
      if (!confirm("Remove this annual goal?")) return;

      const delayMs = 500 + Math.random() * 1500;
      const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));

      try {
        showActionLoader({
          main: "Removing goal…",
          sub: "Updating your annual plan"
        });

        const fetchPromise = fetch(API_BASE + "/annual-goals/" + id, {
          method: "DELETE",
          headers: { "Accept": "application/json" }
        });

        const res = await Promise.all([fetchPromise, delayPromise]).then(
          ([res]) => res
        );

        if (!res.ok && res.status !== 204) {
          throw new Error("Delete failed");
        }

        await loadAnnualGoals();
        showToast("Annual goal removed");
      } catch (err) {
        console.error(err);
        showToast("Error removing annual goal", true);
      } finally {
        hideActionLoader();
      }
    }


    async function deleteMonthlyGoal(id) {
      if (!id) return;
      if (!confirm("Remove this monthly goal?")) return;

      // random delay between 500ms and 2000ms, plus action loader
      const delayMs = 500 + Math.random() * 1500;
      const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));

      try {
        showActionLoader({
          main: "Removing goal…",
          sub: "Updating your monthly focuses"
        });

        const fetchPromise = fetch(API_BASE + "/monthly-goals/" + id, {
          method: "DELETE",
          headers: { "Accept": "application/json" }
        });

        const res = await Promise.all([fetchPromise, delayPromise]).then(
          ([res]) => res
        );

        if (!res.ok && res.status !== 204) {
          throw new Error("Delete failed");
        }

        await loadMonthlyGoals();
        showToast("Monthly goal removed");
      } catch (err) {
        console.error(err);
        showToast("Error removing monthly goal", true);
      } finally {
        hideActionLoader();
      }
    }


    async function updateAnnualGoal(id, patch) {
      try {
        await apiSend("/annual-goals/" + id, "PATCH", patch);
      } catch (err) {
        console.error(err);
        showToast("Error updating annual goal", true);
      }
    }

    async function createAnnualGoal(payload) {
      try {
        await apiSend("/annual-goals", "POST", payload);
        await loadAnnualGoals();
      } catch (err) {
        console.error(err);
        throw err;
      }
    }
  </script>
</body>
</html>
