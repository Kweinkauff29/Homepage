<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GrowthZone Contact Search</title>
<style>
    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 16px;
    }

    #searchArea {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
    }

    #contactSearch {
        padding: 6px 10px;
        min-width: 260px;
        font-size: 14px;
        margin-left: 4px;
    }

    #searchResults {
        margin-top: 8px;
        max-width: 600px;
    }

    #searchResults ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border: 1px solid #eee;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
    }

    #searchResults li {
        padding: 6px 8px;
        cursor: pointer;
        font-size: 13px;
        border-bottom: 1px solid #eee;
    }

    #searchResults li:last-child {
        border-bottom: none;
    }

    #searchResults li:hover {
        background: #f0f0f0;
    }

    .notes-fields {
        margin-top: 8px;
        font-size: 12px;
        background: #f5f5f5;
        padding: 6px;
        border-radius: 4px;
        white-space: pre-wrap;
        max-width: 800px;
        overflow-x: auto;
    }

    #statusLine {
        margin-top: 8px;
        font-size: 12px;
        color: #555;
    }

    /* All names list */
    #allNames {
        margin-top: 24px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 8px;
        max-width: 800px;
    }

    #allNames h2 {
        margin-top: 0;
        font-size: 16px;
    }

    #allNames ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #allNames li {
        padding: 4px 6px;
        cursor: pointer;
        font-size: 13px;
        border-bottom: 1px solid #f0f0f0;
    }

    #allNames li:last-child {
        border-bottom: none;
    }

    #allNames li:hover {
        background: #f5f5f5;
    }
</style>
</head>
<body>
    <h1>GrowthZone Contact Search</h1>

    <!-- Search Area -->
    <div id="searchArea">
        <div>
            <label for="contactSearch">Search by Name:</label>
            <input
              type="text"
              id="contactSearch"
              placeholder="Start typing a name..."
              autocomplete="off"
              disabled
            />
        </div>
        <div id="statusLine">Loading contactsâ€¦</div>
        <div id="searchResults"></div>
        <pre id="searchNotes" class="notes-fields"></pre>
    </div>

    <!-- All active contacts list -->
    <div id="allNames">
        <h2>All Active Individual Contacts</h2>
        <div id="allNamesList"><small>Loadingâ€¦</small></div>
    </div>

    <script>
    // ------------------------------------------------------------------------
    // CONFIG
    // ------------------------------------------------------------------------
    const apiKey = 'cR1djHVMkndNjLbwXyhDyOV7dWPJ6TnufYtcdOHc'; // test only; donâ€™t expose in production
    const BASE_URL = 'https://bonitaspringsesterorealtorsfl.growthzoneapp.com';
    const CONTACTS_BASE_URL = `${BASE_URL}/api/contacts`;
    const PAGE_SIZE_FALLBACK = 100; // if we canâ€™t infer from API

    // OrgGeneral endpoint for a contact
    // GET /api/contacts/OrgGeneral/{contactId}
    function buildCategorySummaryUrl(contactId) {
      return `${BASE_URL}/api/contacts/${encodeURIComponent(contactId)}`;
    }

    const searchInput      = document.getElementById('contactSearch');
    const searchResultsDiv = document.getElementById('searchResults');
    const searchNotesPre   = document.getElementById('searchNotes');
    const statusLine       = document.getElementById('statusLine');
    const allNamesListDiv  = document.getElementById('allNamesList');

    let allContacts = [];          // all active individual contacts
    let searchDebounceHandle = null;

    // ------------------------------------------------------------------------
    // BOOTSTRAP
    // ------------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Fetch all contacts (all pages), then filter to Active individuals
        const activeContacts = await fetchAllContactsActiveIndividuals();
        allContacts = activeContacts;

        statusLine.textContent = `Loaded ${allContacts.length.toLocaleString()} active individual contacts. Click a name or type at least 3 letters to search.`;
        searchInput.disabled = false;

        // Show all names in HTML
        renderAllNames(allContacts);

        // Wire up search
        setupSearch();
      } catch (err) {
        console.error('Error loading contacts:', err);
        statusLine.textContent = 'Error loading contacts. See console for details.';
        allNamesListDiv.innerHTML = '<small>Error loading contacts.</small>';
      }
    });

    // ------------------------------------------------------------------------
    // PAGINATED CONTACT FETCH (ALL PAGES, THEN FILTER)
    // ------------------------------------------------------------------------
    async function fetchAllContactsActiveIndividuals() {
      let all = [];

      // First page (skip 0) to discover total + page size
      const firstUrl = `${CONTACTS_BASE_URL}?skip=0&orderBy=ContactId`;
      const firstRes = await fetch(firstUrl, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'ApiKey ' + apiKey
        }
      });

      const firstData = await firstRes.json();
      const firstResults = firstData.Results || [];

      if (!firstResults.length) {
        return [];
      }

      const totalAvailable = firstData.TotalRecordAvailable || firstResults.length;
      const pageSize = firstResults.length || PAGE_SIZE_FALLBACK;

      console.log('Contacts first page:', {
        totalAvailable,
        pageSize
      });

      all = all.concat(firstResults);

      // Build list of remaining page requests
      const remainingPromises = [];
      for (let skip = pageSize; skip < totalAvailable; skip += pageSize) {
        const url = `${CONTACTS_BASE_URL}?skip=${skip}&orderBy=ContactId`;

        const p = fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'ApiKey ' + apiKey
          }
        })
        .then(res => res.json())
        .then(data => {
          const resArr = data.Results || [];
          console.log('Contacts page', { skip, count: resArr.length });
          return resArr;
        });

        remainingPromises.push(p);
      }

      // Fetch all remaining pages in parallel
      const remainingPages = await Promise.all(remainingPromises);
      remainingPages.forEach(arr => { all = all.concat(arr); });

      console.log('Total contacts fetched (all statuses, all types):', all.length);

      // Filter here: Active only + individuals only
      const filtered = all.filter(c =>
        c.Status === 'Active' &&
        c.SystemContactTypeId === 1  // individuals
      );

      console.log('Filtered active individual contacts:', filtered.length);

      return filtered;
    }

    // ------------------------------------------------------------------------
    // CATEGORY SUMMARY (OrgGeneral endpoint)
    // ------------------------------------------------------------------------
    async function fetchCategorySummary(contactId) {
      const url = buildCategorySummaryUrl(contactId);

      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'ApiKey ' + apiKey   // ðŸ”§ THIS WAS MISSING
        }
      });

      if (!res.ok) {
        const text = await res.text().catch(() => '');
        console.error('Error fetching categorySummary:', res.status, text);
        throw new Error('Failed to fetch categorySummary');
      }

      const data = await res.json();
      console.log(`categorySummary for contact ${contactId}:`, data);
      return data;
    }

    // ------------------------------------------------------------------------
    // RENDER ALL NAMES
    // ------------------------------------------------------------------------
    function renderAllNames(contacts) {
      if (!contacts.length) {
        allNamesListDiv.innerHTML = '<small>No active individual contacts found.</small>';
        return;
      }

      const ul = document.createElement('ul');

      contacts.forEach(contact => {
        const li = document.createElement('li');
        const city = contact.City ? ` â€” ${contact.City}` : '';
        li.textContent = `${contact.Name} (ID: ${contact.ContactId})${city}`;

        // Clicking a name in the full list pulls categorySummary
        li.addEventListener('click', async () => {
          searchNotesPre.textContent =
            `Loading category summary for ${contact.Name} (ID: ${contact.ContactId})â€¦`;
          try {
            const cs = await fetchCategorySummary(contact.ContactId);
            searchNotesPre.textContent = JSON.stringify(cs, null, 2);
          } catch (err) {
            searchNotesPre.textContent =
              'Error loading category summary. See console for details.';
            console.error(err);
          }
        });

        ul.appendChild(li);
      });

      allNamesListDiv.innerHTML = '';
      allNamesListDiv.appendChild(ul);
    }

    // ------------------------------------------------------------------------
    // SEARCH
    // ------------------------------------------------------------------------
    function setupSearch() {
      searchResultsDiv.innerHTML = '';
      searchNotesPre.textContent = '';

      searchInput.addEventListener('input', () => {
        const term = searchInput.value.trim().toLowerCase();

        clearTimeout(searchDebounceHandle);
        searchDebounceHandle = setTimeout(() => {
          if (term.length < 3) {
            searchResultsDiv.innerHTML = '<small>Type at least 3 letters to search.</small>';
            return;
          }

          const results = allContacts
            .filter(c => c.Name && c.Name.toLowerCase().includes(term))
            .slice(0, 25); // cap list

          renderSearchResults(results);
        }, 200);
      });

      // initial hint
      searchResultsDiv.innerHTML = '<small>Type at least 3 letters to search.</small>';
    }

    function renderSearchResults(results) {
      searchResultsDiv.innerHTML = '';

      if (!results.length) {
        searchResultsDiv.innerHTML = '<small>No matches found.</small>';
        return;
      }

      const ul = document.createElement('ul');

      results.forEach(contact => {
        const li = document.createElement('li');
        const city = contact.City ? ` â€” ${contact.City}` : '';
        li.textContent = `${contact.Name} (ID: ${contact.ContactId})${city}`;

        li.addEventListener('click', async () => {
          searchNotesPre.textContent =
            `Loading category summary for ${contact.Name} (ID: ${contact.ContactId})â€¦`;
          try {
            const cs = await fetchCategorySummary(contact.ContactId);
            searchNotesPre.textContent = JSON.stringify(cs, null, 2);
          } catch (err) {
            searchNotesPre.textContent =
              'Error loading category summary. See console for details.';
            console.error(err);
          }
        });

        ul.appendChild(li);
      });

      searchResultsDiv.appendChild(ul);
    }
    </script>
</body>
</html>
